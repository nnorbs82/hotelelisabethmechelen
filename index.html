<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Elisabeth Mechelen - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Fixed Background Layer (iOS Compatible) -->
    <div id="page-background" class="page-background"></div>
    
    <header>
        <nav>
            <a class="nav-logo" href="index.html">
                <img src="logo/elitext.png" alt="Hotel Elisabeth Mechelen logo">
            </a>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="offers.html">Offers</a></li>
                <li><a href="facilities.html">Facilities</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="info.html">Info</a></li>
                <li><a href="attractions.html">Attractions</a></li>
                <li><a href="photos.html">Photos</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero-slideshow" aria-label="Hotel Elisabeth main banner">
            <div class="hero-slider">
                <div class="hero-track" id="hero-track"></div>
                <button class="hero-handle hero-handle-left" id="hero-prev" aria-label="Previous banner image" type="button">&#10094;</button>
                <button class="hero-handle hero-handle-right" id="hero-next" aria-label="Next banner image" type="button">&#10095;</button>
                
                <!-- Booking Bar -->
                <div class="booking-bar">
                    <div class="booking-field">
                        <label for="checkin-date">Check-in</label>
                        <input type="text" id="checkin-date" placeholder="Select date" readonly>
                    </div>
                    <div class="booking-field">
                        <label for="checkout-date">Check-out</label>
                        <input type="text" id="checkout-date" placeholder="Select date" readonly>
                    </div>
                    <button id="search-btn" class="btn booking-search-btn">Search</button>
                </div>
            </div>
        </section>

        <!-- Index Ads Section -->
        <section id="index-ads-section" style="display: none;"></section>

        <!-- About Us Section -->
        <section id="about-us-section" class="about-us-section">
            <div class="about-us-container">
                <h2 id="about-us-title" class="about-us-title">ELISABETH HOTEL</h2>
                <div class="about-us-content">
                    <div class="about-us-left">
                        <h3 id="about-us-left-subtitle1" class="about-us-subtitle"></h3>
                        <h3 id="about-us-left-subtitle2" class="about-us-subtitle"></h3>
                        <p id="about-us-left-body" class="about-us-body"></p>
                    </div>
                    <div class="about-us-right">
                        <h3 id="about-us-right-subtitle1" class="about-us-subtitle"></h3>
                        <h3 id="about-us-right-subtitle2" class="about-us-subtitle"></h3>
                        <p id="about-us-right-body" class="about-us-body"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ads Bottom Section -->
        <section id="ads-bottom-section" style="display: none;"></section>

        <div class="container">
            <div class="card">
                <h2>Welcome to Hotel Elisabeth Mechelen</h2>
                <p>Experience luxury and comfort in the heart of Mechelen.</p>
                <a href="rooms.html" class="btn">View Our Rooms</a>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 Hotel Elisabeth Mechelen. All rights reserved.</p>
        <p>
            <a href="privacypolicy.html" style="color: var(--color-beige); margin: 0 1rem;">Privacy Policy</a> | 
            <a href="termsandconditions.html" style="color: var(--color-beige); margin: 0 1rem;">Terms & Conditions</a> | 
            <a href="policies.html" style="color: var(--color-beige); margin: 0 1rem;">Hotel Policies</a> | 
            <a href="career.html" style="color: var(--color-beige); margin: 0 1rem;">Careers</a>
        </p>
    </footer>
    <script type="module">
        import { database, storage } from './firebase-config.js';
        import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { ref as storageRef, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const heroTrack = document.getElementById('hero-track');
        const prevButton = document.getElementById('hero-prev');
        const nextButton = document.getElementById('hero-next');
        const slideIntervalMs = 5000;
        const slideTransitionMs = 800;
        let currentIndex = 0;
        let slideCount = 0;
        let autoTimer = null;
        let safeguardTimer = null;
        let useClones = false;

        async function fetchBannerUrls() {
            const urls = [];

            try {
                const snapshot = await get(dbRef(database, 'mainBanner'));
                if (snapshot.exists()) {
                    const data = Object.values(snapshot.val())
                        .filter(item => item && item.url)
                        .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                    data.forEach(item => urls.push(item.url));
                }
            } catch (error) {
                console.error('Error loading main banner metadata:', error);
            }

            if (urls.length) {
                return urls;
            }

            const folders = ['mainBanner', 'main-banner'];
            for (const folder of folders) {
                try {
                    const listResult = await listAll(storageRef(storage, folder));
                    if (listResult.items.length) {
                        const storageUrls = await Promise.all(
                            listResult.items.map(item => getDownloadURL(item))
                        );
                        urls.push(...storageUrls);
                        break;
                    }
                } catch (error) {
                    console.warn(`Unable to list storage folder ${folder}:`, error);
                }
            }

            return urls;
        }

        // Handle page visibility changes to prevent black screen when returning from inactive tab
        let slideshowInitialized = false;

        function startSafeguardTimer() {
            if (slideCount > 1 && !safeguardTimer) {
                safeguardTimer = setInterval(() => {
                    if (!document.hidden && slideshowInitialized && slideCount > 1 && !autoTimer) {
                        console.log('Slideshow timer lost - restarting');
                        startAutoSlide();
                    }
                }, 2000);
            }
        }

        function stopSafeguardTimer() {
            if (safeguardTimer) {
                clearInterval(safeguardTimer);
                safeguardTimer = null;
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Tab is now hidden - pause the slideshow
                stopAutoSlide();
                stopSafeguardTimer();
            } else {
                // Tab is now visible again
                if (slideshowInitialized && slideCount > 0) {
                    // Reset the slideshow position and restart
                    console.log('Tab visible again - restarting slideshow');
                    
                    // Force a re-render of the current position
                    setTrackPosition(false);
                    
                    // Restart the auto-slide
                    startAutoSlide();
                }
                // Restart the safeguard timer when tab becomes visible
                startSafeguardTimer();
            }
        });

        function toggleHandles(enabled) {
            [prevButton, nextButton].forEach(button => {
                button.disabled = !enabled;
                button.setAttribute('aria-disabled', (!enabled).toString());
            });
        }

        function setTrackPosition(animate = true) {
            heroTrack.style.transition = animate ? `transform ${slideTransitionMs}ms ease-in-out` : 'none';
            heroTrack.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        function startAutoSlide() {
            if (slideCount <= 1) {
                return;
            }
            stopAutoSlide();
            autoTimer = setInterval(() => moveSlide(1), slideIntervalMs);
        }

        function stopAutoSlide() {
            if (autoTimer) {
                clearInterval(autoTimer);
                autoTimer = null;
            }
        }

        function resetAutoSlide() {
            stopAutoSlide();
            startAutoSlide();
        }

        function moveSlide(direction, manual = false) {
            if (slideCount <= 1) {
                return;
            }
            currentIndex += direction;
            setTrackPosition(true);

            if (manual) {
                resetAutoSlide();
            }
        }

        function buildSlides(urls) {
            heroTrack.innerHTML = '';
            slideCount = urls.length;
            useClones = slideCount > 1;

            if (!slideCount) {
                const placeholder = document.createElement('div');
                placeholder.className = 'hero-slide hero-slide-placeholder';
                placeholder.textContent = 'Main banner images coming soon.';
                heroTrack.appendChild(placeholder);
                toggleHandles(false);
                slideshowInitialized = false;
                return;
            }

            const slidesToRender = [];
            if (useClones) {
                slidesToRender.push(urls[slideCount - 1], ...urls, urls[0]);
                currentIndex = 1;
            } else {
                slidesToRender.push(...urls);
                currentIndex = 0;
            }

            slidesToRender.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'hero-slide';
                const img = document.createElement('img');
                img.src = url;
                img.alt = `Main banner image ${useClones ? ((index || slideCount) % slideCount) + 1 : index + 1}`;
                
                // Add error handling for images that fail to load
                img.onerror = function() {
                    console.error('Failed to load banner image:', url);
                };
                
                slide.appendChild(img);
                heroTrack.appendChild(slide);
            });

            toggleHandles(slideCount > 1);
            requestAnimationFrame(() => setTrackPosition(false));
            startAutoSlide();
            slideshowInitialized = true;
            
            // Start the safeguard timer if slideshow has multiple slides
            startSafeguardTimer();
        }

        heroTrack.addEventListener('transitionend', () => {
            if (!useClones) {
                return;
            }

            if (currentIndex === 0) {
                currentIndex = slideCount;
                setTrackPosition(false);
            }

            if (currentIndex === slideCount + 1) {
                currentIndex = 1;
                setTrackPosition(false);
            }
        });

        prevButton.addEventListener('click', () => moveSlide(-1, true));
        nextButton.addEventListener('click', () => moveSlide(1, true));
        window.addEventListener('resize', () => setTrackPosition(false));

        fetchBannerUrls().then(buildSlides);

        // ============ INDEX ADS DISPLAY ============
        const adsSection = document.getElementById('index-ads-section');
        
        // Detect browser language or default to English
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('nl')) return 'nl';
            if (browserLang.startsWith('fr')) return 'fr';
            return 'en';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Validate and sanitize URL for CSS background-image
        function sanitizeImageUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            // Only allow HTTPS URLs from Firebase Storage or relative paths
            if (trimmed.startsWith('https://firebasestorage.googleapis.com/') || 
                trimmed.startsWith('https://storage.googleapis.com/')) {
                // Additional validation: ensure no quotes or parentheses that could break CSS
                if (trimmed.includes("'") || trimmed.includes('"') || trimmed.includes('(') || trimmed.includes(')')) {
                    return '';
                }
                return trimmed;
            }
            return '';
        }

        // Validate URL to prevent javascript: and other malicious schemes
        function sanitizeUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://') || trimmed.startsWith('/')) {
                return trimmed;
            }
            return ''; // Block non-HTTP(S) URLs
        }

        // Helper to render ad button
        function renderAdButton(ad, lang) {
            const link = sanitizeUrl(ad.link);
            const buttonTitle = escapeHtml(ad[`buttonTitle_${lang}`] || 'Learn More');
            return link ? `<a href="${escapeHtml(link)}" class="index-ad-button">${buttonTitle}</a>` : '';
        }

        async function loadIndexAds() {
            try {
                const snapshot = await get(dbRef(database, 'indexAds'));
                
                if (!snapshot.exists()) {
                    return; // No ads to display
                }

                const adsData = snapshot.val();
                const currentLang = detectLanguage();
                
                // Check if we have all three ads with required data
                const ad1 = adsData.ad1;
                const ad2 = adsData.ad2;
                const ad3 = adsData.ad3;
                
                if (!ad1 || !ad2 || !ad3) {
                    return; // Not all ads configured
                }

                // Render the ads with proper escaping
                adsSection.innerHTML = `
                    <div class="index-ads-container">
                        <div class="index-ads-left" style="background-image: url('${sanitizeImageUrl(ad1.imageUrl)}');">
                            <div class="index-ad-content">
                                <div class="index-ad-top-text">${escapeHtml(ad1[`topText_${currentLang}`])}</div>
                                <div class="index-ad-bottom-text">${escapeHtml(ad1[`bottomText_${currentLang}`])}</div>
                                ${renderAdButton(ad1, currentLang)}
                            </div>
                        </div>
                        <div class="index-ads-right">
                            <div class="index-ads-right-top" style="background-image: url('${sanitizeImageUrl(ad2.imageUrl)}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad2[`topText_${currentLang}`])}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad2[`bottomText_${currentLang}`])}</div>
                                    ${renderAdButton(ad2, currentLang)}
                                </div>
                            </div>
                            <div class="index-ads-right-bottom" style="background-image: url('${sanitizeImageUrl(ad3.imageUrl)}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad3[`topText_${currentLang}`])}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad3[`bottomText_${currentLang}`])}</div>
                                    ${renderAdButton(ad3, currentLang)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading index ads:', error);
            }
        }

        // Load ads after banner loads
        loadIndexAds();

        // ============ ABOUT US CONTENT ============
        // Load About Us content
        async function loadAboutUsContent() {
            try {
                const snapshot = await get(dbRef(database, 'aboutUs'));
                
                if (!snapshot.exists()) {
                    return;
                }
                
                const data = snapshot.val();
                const currentLang = detectLanguage();
                
                // Set title
                document.getElementById('about-us-title').textContent = data.title[currentLang] || '';
                
                // Set left content
                document.getElementById('about-us-left-subtitle1').textContent = data.left.subtitle1[currentLang] || '';
                document.getElementById('about-us-left-subtitle2').textContent = data.left.subtitle2[currentLang] || '';
                document.getElementById('about-us-left-body').textContent = data.left.textBody[currentLang] || '';
                
                // Set right content
                document.getElementById('about-us-right-subtitle1').textContent = data.right.subtitle1[currentLang] || '';
                document.getElementById('about-us-right-subtitle2').textContent = data.right.subtitle2[currentLang] || '';
                document.getElementById('about-us-right-body').textContent = data.right.textBody[currentLang] || '';
                
            } catch (error) {
                console.error('Error loading About Us content:', error);
            }
        }

        // Load About Us after page loads
        loadAboutUsContent();

        // ============ ADS BOTTOM SECTION ============
        async function loadAdsBottom() {
            try {
                const snapshot = await get(dbRef(database, 'adsBottom'));
                
                if (!snapshot.exists()) {
                    return; // No data to display
                }
                
                const data = snapshot.val();
                const adsBottomSection = document.getElementById('ads-bottom-section');
                
                // Check if we have all required data
                if (!data.titles || !data.ad1 || !data.ad2 || !data.ad3) {
                    return; // Not all data configured
                }
                
                // Render the Ads Bottom section with proper escaping
                adsBottomSection.innerHTML = `
                    <div class="ads-bottom-container">
                        <div class="ads-bottom-overlay"></div>
                        <div class="ads-bottom-content">
                            <div class="ads-bottom-titles">
                                <h2 class="ads-bottom-title">${escapeHtml(data.titles[`title1_${currentLang}`] || '')}</h2>
                                <h3 class="ads-bottom-subtitle">${escapeHtml(data.titles[`title2_${currentLang}`] || '')}</h3>
                                <h3 class="ads-bottom-subtitle">${escapeHtml(data.titles[`title3_${currentLang}`] || '')}</h3>
                            </div>
                            <div class="ads-bottom-cards">
                                <div class="ads-bottom-card" style="background-image: url('${sanitizeImageUrl(data.ad1.imageUrl)}');">
                                    <div class="ads-bottom-card-content">
                                        <h4>${escapeHtml(data.ad1[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad1[`body_${currentLang}`] || '').replace(/\n/g, '<br>')}</p>
                                    </div>
                                </div>
                                <div class="ads-bottom-card" style="background-image: url('${sanitizeImageUrl(data.ad2.imageUrl)}');">
                                    <div class="ads-bottom-card-content">
                                        <h4>${escapeHtml(data.ad2[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad2[`body_${currentLang}`] || '').replace(/\n/g, '<br>')}</p>
                                    </div>
                                </div>
                                <div class="ads-bottom-card" style="background-image: url('${sanitizeImageUrl(data.ad3.imageUrl)}');">
                                    <div class="ads-bottom-card-content">
                                        <h4>${escapeHtml(data.ad3[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad3[`body_${currentLang}`] || '').replace(/\n/g, '<br>')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsBottomSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading Ads Bottom:', error);
            }
        }
        
        // Load Ads Bottom after page loads
        loadAdsBottom();

        // ============ PAGE BACKGROUND MANAGEMENT ============
        // Load and display background image
        async function loadPageBackground() {
            try {
                const snapshot = await get(dbRef(database, 'indexBackground'));
                
                if (snapshot.exists()) {
                    const bgData = snapshot.val();
                    const bgElement = document.getElementById('page-background');
                    if (bgElement && bgData.url) {
                        bgElement.style.backgroundImage = `url('${bgData.url}')`;
                    }
                }
            } catch (error) {
                console.error('Error loading page background:', error);
            }
        }

        // Load background on page load
        loadPageBackground();
    </script>
    <script src="booking-bar.js"></script>
</body>
</html>
