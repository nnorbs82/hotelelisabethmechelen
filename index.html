<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Elisabeth Mechelen - Home</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <a class="nav-logo" href="index.html">
                <img src="logo/elitext.png" alt="Hotel Elisabeth Mechelen logo">
            </a>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="offers.html">Offers</a></li>
                <li><a href="facilities.html">Facilities</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="info.html">Info</a></li>
                <li><a href="attractions.html">Attractions</a></li>
                <li><a href="photos.html">Photos</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero-slideshow" aria-label="Hotel Elisabeth main banner">
            <div class="hero-slider">
                <div class="hero-track" id="hero-track"></div>
                <button class="hero-handle hero-handle-left" id="hero-prev" aria-label="Previous banner image" type="button">&#10094;</button>
                <button class="hero-handle hero-handle-right" id="hero-next" aria-label="Next banner image" type="button">&#10095;</button>
                
                <!-- Booking Bar -->
                <div class="booking-bar">
                    <div class="booking-field">
                        <label for="checkin-date">Check-in</label>
                        <input type="text" id="checkin-date" placeholder="Select date" readonly>
                    </div>
                    <div class="booking-field">
                        <label for="checkout-date">Check-out</label>
                        <input type="text" id="checkout-date" placeholder="Select date" readonly>
                    </div>
                    <button id="search-btn" class="btn booking-search-btn">Search</button>
                </div>
            </div>
        </section>

        <!-- Index Ads Section -->
        <section id="index-ads-section" style="display: none;"></section>

        <div class="container">
            <div class="card">
                <h2>Welcome to Hotel Elisabeth Mechelen</h2>
                <p>Experience luxury and comfort in the heart of Mechelen.</p>
                <a href="rooms.html" class="btn">View Our Rooms</a>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2026 Hotel Elisabeth Mechelen. All rights reserved.</p>
        <p>
            <a href="privacypolicy.html" style="color: var(--color-beige); margin: 0 1rem;">Privacy Policy</a> | 
            <a href="termsandconditions.html" style="color: var(--color-beige); margin: 0 1rem;">Terms & Conditions</a> | 
            <a href="policies.html" style="color: var(--color-beige); margin: 0 1rem;">Hotel Policies</a> | 
            <a href="career.html" style="color: var(--color-beige); margin: 0 1rem;">Careers</a>
        </p>
    </footer>
    <script type="module">
        import { database, storage } from './firebase-config.js';
        import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { ref as storageRef, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const heroTrack = document.getElementById('hero-track');
        const prevButton = document.getElementById('hero-prev');
        const nextButton = document.getElementById('hero-next');
        const slideIntervalMs = 10000;
        const slideTransitionMs = 800;
        let currentIndex = 0;
        let slideCount = 0;
        let autoTimer = null;
        let useClones = false;

        async function fetchBannerUrls() {
            const urls = [];

            try {
                const snapshot = await get(dbRef(database, 'mainBanner'));
                if (snapshot.exists()) {
                    const data = Object.values(snapshot.val())
                        .filter(item => item && item.url)
                        .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                    data.forEach(item => urls.push(item.url));
                }
            } catch (error) {
                console.error('Error loading main banner metadata:', error);
            }

            if (urls.length) {
                return urls;
            }

            const folders = ['mainBanner', 'main-banner'];
            for (const folder of folders) {
                try {
                    const listResult = await listAll(storageRef(storage, folder));
                    if (listResult.items.length) {
                        const storageUrls = await Promise.all(
                            listResult.items.map(item => getDownloadURL(item))
                        );
                        urls.push(...storageUrls);
                        break;
                    }
                } catch (error) {
                    console.warn(`Unable to list storage folder ${folder}:`, error);
                }
            }

            return urls;
        }

        function toggleHandles(enabled) {
            [prevButton, nextButton].forEach(button => {
                button.disabled = !enabled;
                button.setAttribute('aria-disabled', (!enabled).toString());
            });
        }

        function setTrackPosition(animate = true) {
            heroTrack.style.transition = animate ? `transform ${slideTransitionMs}ms ease-in-out` : 'none';
            heroTrack.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        function startAutoSlide() {
            if (slideCount <= 1) {
                return;
            }
            stopAutoSlide();
            autoTimer = setInterval(() => moveSlide(1), slideIntervalMs);
        }

        function stopAutoSlide() {
            if (autoTimer) {
                clearInterval(autoTimer);
                autoTimer = null;
            }
        }

        function resetAutoSlide() {
            stopAutoSlide();
            startAutoSlide();
        }

        function moveSlide(direction, manual = false) {
            if (slideCount <= 1) {
                return;
            }
            currentIndex += direction;
            setTrackPosition(true);

            if (manual) {
                resetAutoSlide();
            }
        }

        function buildSlides(urls) {
            heroTrack.innerHTML = '';
            slideCount = urls.length;
            useClones = slideCount > 1;

            if (!slideCount) {
                const placeholder = document.createElement('div');
                placeholder.className = 'hero-slide hero-slide-placeholder';
                placeholder.textContent = 'Main banner images coming soon.';
                heroTrack.appendChild(placeholder);
                toggleHandles(false);
                return;
            }

            const slidesToRender = [];
            if (useClones) {
                slidesToRender.push(urls[slideCount - 1], ...urls, urls[0]);
                currentIndex = 1;
            } else {
                slidesToRender.push(...urls);
                currentIndex = 0;
            }

            slidesToRender.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'hero-slide';
                const img = document.createElement('img');
                img.src = url;
                img.alt = `Main banner image ${useClones ? ((index || slideCount) % slideCount) + 1 : index + 1}`;
                slide.appendChild(img);
                heroTrack.appendChild(slide);
            });

            toggleHandles(slideCount > 1);
            requestAnimationFrame(() => setTrackPosition(false));
            startAutoSlide();
        }

        heroTrack.addEventListener('transitionend', () => {
            if (!useClones) {
                return;
            }

            if (currentIndex === 0) {
                currentIndex = slideCount;
                setTrackPosition(false);
            }

            if (currentIndex === slideCount + 1) {
                currentIndex = 1;
                setTrackPosition(false);
            }
        });

        prevButton.addEventListener('click', () => moveSlide(-1, true));
        nextButton.addEventListener('click', () => moveSlide(1, true));
        window.addEventListener('resize', () => setTrackPosition(false));

        fetchBannerUrls().then(buildSlides);

        // ============ INDEX ADS DISPLAY ============
        const adsSection = document.getElementById('index-ads-section');
        
        // Detect browser language or default to English
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('nl')) return 'nl';
            if (browserLang.startsWith('fr')) return 'fr';
            return 'en';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Validate URL to prevent javascript: and other malicious schemes
        function sanitizeUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://') || trimmed.startsWith('/')) {
                return trimmed;
            }
            return ''; // Block non-HTTP(S) URLs
        }

        async function loadIndexAds() {
            try {
                const snapshot = await get(dbRef(database, 'indexAds'));
                
                if (!snapshot.exists()) {
                    return; // No ads to display
                }

                const adsData = snapshot.val();
                const currentLang = detectLanguage();
                
                // Check if we have all three ads with required data
                const ad1 = adsData.ad1;
                const ad2 = adsData.ad2;
                const ad3 = adsData.ad3;
                
                if (!ad1 || !ad2 || !ad3) {
                    return; // Not all ads configured
                }

                // Render the ads with proper escaping
                adsSection.innerHTML = `
                    <div class="index-ads-container">
                        <div class="index-ads-left" style="background-image: url('${escapeHtml(ad1.imageUrl || '')}');">
                            <div class="index-ad-content">
                                <div class="index-ad-top-text">${escapeHtml(ad1[`topText_${currentLang}`] || '')}</div>
                                <div class="index-ad-bottom-text">${escapeHtml(ad1[`bottomText_${currentLang}`] || '')}</div>
                                ${ad1.link && sanitizeUrl(ad1.link) ? `<a href="${escapeHtml(sanitizeUrl(ad1.link))}" class="index-ad-button">${escapeHtml(ad1[`buttonTitle_${currentLang}`] || 'Learn More')}</a>` : ''}
                            </div>
                        </div>
                        <div class="index-ads-right">
                            <div class="index-ads-right-top" style="background-image: url('${escapeHtml(ad2.imageUrl || '')}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad2[`topText_${currentLang}`] || '')}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad2[`bottomText_${currentLang}`] || '')}</div>
                                    ${ad2.link && sanitizeUrl(ad2.link) ? `<a href="${escapeHtml(sanitizeUrl(ad2.link))}" class="index-ad-button">${escapeHtml(ad2[`buttonTitle_${currentLang}`] || 'Learn More')}</a>` : ''}
                                </div>
                            </div>
                            <div class="index-ads-right-bottom" style="background-image: url('${escapeHtml(ad3.imageUrl || '')}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad3[`topText_${currentLang}`] || '')}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad3[`bottomText_${currentLang}`] || '')}</div>
                                    ${ad3.link && sanitizeUrl(ad3.link) ? `<a href="${escapeHtml(sanitizeUrl(ad3.link))}" class="index-ad-button">${escapeHtml(ad3[`buttonTitle_${currentLang}`] || 'Learn More')}</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading index ads:', error);
            }
        }

        // Load ads after banner loads
        loadIndexAds();
    </script>
    <script src="booking-bar.js"></script>
</body>
</html>
