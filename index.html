<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Elisabeth Mechelen - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Navigation Menu -->
    <header class="main-menu">
        <a href="index.html">
            <img src="logo/elitext.png" alt="Hotel Elisabeth Mechelen" class="main-menu-logo">
        </a>
        <div class="mobile-header-controls">
            <a href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" class="booking-button" target="_blank" rel="noopener noreferrer">Book Now</a>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu">
                â˜°
            </button>
        </div>
        <nav class="main-nav" id="main-nav">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="packages.html">Packages</a></li>
                <li><a href="facilities.html">Facilities</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="info.html">Info</a></li>
                <li class="dropdown">
                    <button id="more-btn">More</button>
                    <div class="dropdown-menu" id="more-dropdown">
                        <a href="attractions.html">Attractions</a>
                        <a href="grouprequest.html">Group Request</a>
                    </div>
                </li>
                <li><a href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" class="booking-button" target="_blank" rel="noopener noreferrer">Book Now</a></li>
            </ul>
        </nav>
    </header>
    
    <!-- Fixed Background Layer (iOS Compatible) -->
    <div id="page-background" class="page-background"></div>
    

    <main>
        <section class="hero-slideshow" aria-label="Hotel Elisabeth main banner">
            <div class="hero-slider">
                <div class="hero-track" id="hero-track"></div>
                <button class="hero-handle hero-handle-left" id="hero-prev" aria-label="Previous banner image" type="button">&#10094;</button>
                <button class="hero-handle hero-handle-right" id="hero-next" aria-label="Next banner image" type="button">&#10095;</button>
                
                <!-- Logo (moved from hero-bottom-left) -->
                <img src="logo/logo.png" alt="Hotel Elisabeth" class="hero-bottom-logo">
                
                <!-- Booking Bar (moved from hero-bottom-right) -->
                <div class="booking-bar">
                    <div class="booking-field">
                        <label for="checkin-date">Check-in</label>
                        <input type="text" id="checkin-date" placeholder="Select date" readonly>
                    </div>
                    <div class="booking-field">
                        <label for="checkout-date">Check-out</label>
                        <input type="text" id="checkout-date" placeholder="Select date" readonly>
                    </div>
                    <button id="search-btn" class="btn booking-search-btn">Search</button>
                </div>
            </div>
        </section>

        <!-- Index Ads Section -->
        <section id="index-ads-section" style="display: none;"></section>

        <!-- About Us Section -->
        <section id="about-us-section" class="about-us-section">
            <div class="about-us-container">
                <h2 id="about-us-title" class="about-us-title">ELISABETH HOTEL</h2>
                <div class="about-us-content">
                    <div class="about-us-left">
                        <h3 id="about-us-left-subtitle1" class="about-us-subtitle"></h3>
                        <h3 id="about-us-left-subtitle2" class="about-us-subtitle"></h3>
                        <p id="about-us-left-body" class="about-us-body"></p>
                    </div>
                    <div class="about-us-right">
                        <h3 id="about-us-right-subtitle1" class="about-us-subtitle"></h3>
                        <h3 id="about-us-right-subtitle2" class="about-us-subtitle"></h3>
                        <p id="about-us-right-body" class="about-us-body"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ads Bottom Section -->
        <section id="ads-bottom-section" style="display: none;"></section>

        <!-- Our Picks Section -->
        <section id="our-picks-section" class="our-picks-section" style="display: none;">
            <div class="our-picks-container">
                <h2 class="our-picks-title">Our Picks</h2>
                <div id="our-picks-list" class="our-picks-list">
                    <!-- Package cards will be dynamically inserted here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Map Section -->
    <section class="map-section">
        <div id="map" class="map-embed" role="img" aria-label="Hotel Elisabeth Mechelen Location"></div>
    </section>

    <footer>
        <div class="footer-container">
            <!-- Logo Section -->
            <div class="footer-section footer-logo-section">
                <img src="logo/logo.png" alt="Hotel Elisabeth Logo" class="footer-logo">
            </div>

            <!-- Contact Section -->
            <div class="footer-section">
                <h3>Contact</h3>
                <div class="footer-contact-info">
                    <div class="footer-contact-item">
                        <strong>PHONE:</strong>
                        <a href="tel:+3215288400">+32 15 28 84 00</a>
                    </div>
                    <div class="footer-contact-item">
                        <strong>EMAIL:</strong>
                        <a href="mailto:info@elisabeth-hotel.be">info@elisabeth-hotel.be</a>
                    </div>
                    <div class="footer-contact-item">
                        <strong>ADDRESS:</strong>
                        <div class="footer-address">
                            <span>GOSWIN DE STASSARTSTRAAT</span>
                            <span>NR 26 / 28</span>
                            <span>MECHELEN 2800</span>
                            <span>BELGIUM</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social Media Section -->
            <div class="footer-section">
                <h3>Social</h3>
                <div class="footer-social">
                    <a href="https://www.instagram.com/hotel.elisabeth" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        Instagram
                    </a>
                    <a href="https://www.facebook.com/hotelelisabeth/" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </a>
                    <a href="https://www.linkedin.com/company/hotel-elisabeth-mechelen/" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </a>
                </div>
            </div>

            <!-- Information Links Section -->
            <div class="footer-section">
                <h3>Information</h3>
                <div class="footer-info-links">
                    <a href="privacypolicy.html">Privacy Policy</a>
                    <a href="termsandconditions.html">Terms & Conditions</a>
                    <a href="policies.html">Hotel Policies</a>
                    <a href="careers.html">Careers</a>
                </div>
            </div>
        </div>

        <!-- Footer Copyright -->
        <div class="footer-copyright-wrapper">
            <p class="footer-copyright">&copy; 2026 Hotel Elisabeth Mechelen. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Main Menu Script -->
    <script src="main-menu.js"></script>
    <script src="language-switcher.js"></script>
    
    <script type="module">
        import { database, storage } from './firebase-config.js';
        import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { ref as storageRef, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const heroTrack = document.getElementById('hero-track');
        const prevButton = document.getElementById('hero-prev');
        const nextButton = document.getElementById('hero-next');
        const slideIntervalMs = 5000;
        const slideTransitionMs = 800;
        let currentIndex = 0;
        let slideCount = 0;
        let autoTimer = null;
        let safeguardTimer = null;
        let useClones = false;

        // Detect browser language or default to English (used globally by all content loading functions)
        function detectLanguage() {
            // First check localStorage for user preference
            const stored = localStorage.getItem('selectedLanguage');
            if (stored && (stored === 'nl' || stored === 'en' || stored === 'fr')) {
                return stored;
            }
            
            // Then check browser language
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('nl')) return 'nl';
            if (browserLang.startsWith('fr')) return 'fr';
            return 'en';
        }

        // Global language setting
        const currentLang = detectLanguage();

        async function fetchBannerUrls() {
            const urls = [];

            try {
                const snapshot = await get(dbRef(database, 'mainBanner'));
                if (snapshot.exists()) {
                    const data = Object.values(snapshot.val())
                        .filter(item => item && item.url)
                        .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                    data.forEach(item => urls.push(item.url));
                }
            } catch (error) {
                console.error('Error loading main banner metadata:', error);
            }

            if (urls.length) {
                return urls;
            }

            const folders = ['mainBanner', 'main-banner'];
            for (const folder of folders) {
                try {
                    const listResult = await listAll(storageRef(storage, folder));
                    if (listResult.items.length) {
                        const storageUrls = await Promise.all(
                            listResult.items.map(item => getDownloadURL(item))
                        );
                        urls.push(...storageUrls);
                        break;
                    }
                } catch (error) {
                    console.warn(`Unable to list storage folder ${folder}:`, error);
                }
            }

            return urls;
        }

        // Handle page visibility changes to prevent black screen when returning from inactive tab
        let slideshowInitialized = false;

        function startSafeguardTimer() {
            if (slideCount > 1 && !safeguardTimer) {
                safeguardTimer = setInterval(() => {
                    if (!document.hidden && slideshowInitialized && slideCount > 1 && !autoTimer) {
                        console.log('Slideshow timer lost - restarting');
                        startAutoSlide();
                    }
                }, 2000);
            }
        }

        function stopSafeguardTimer() {
            if (safeguardTimer) {
                clearInterval(safeguardTimer);
                safeguardTimer = null;
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Tab is now hidden - pause the slideshow
                stopAutoSlide();
                stopSafeguardTimer();
            } else {
                // Tab is now visible again
                if (slideshowInitialized && slideCount > 0) {
                    // Reset the slideshow position and restart
                    console.log('Tab visible again - restarting slideshow');
                    
                    // Force a re-render of the current position
                    setTrackPosition(false);
                    
                    // Restart the auto-slide
                    startAutoSlide();
                }
                // Restart the safeguard timer when tab becomes visible
                startSafeguardTimer();
            }
        });

        function toggleHandles(enabled) {
            [prevButton, nextButton].forEach(button => {
                button.disabled = !enabled;
                button.setAttribute('aria-disabled', (!enabled).toString());
            });
        }

        function setTrackPosition(animate = true) {
            heroTrack.style.transition = animate ? `transform ${slideTransitionMs}ms ease-in-out` : 'none';
            heroTrack.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        function startAutoSlide() {
            if (slideCount <= 1) {
                return;
            }
            stopAutoSlide();
            autoTimer = setInterval(() => moveSlide(1), slideIntervalMs);
        }

        function stopAutoSlide() {
            if (autoTimer) {
                clearInterval(autoTimer);
                autoTimer = null;
            }
        }

        function resetAutoSlide() {
            stopAutoSlide();
            startAutoSlide();
        }

        function moveSlide(direction, manual = false) {
            if (slideCount <= 1) {
                return;
            }
            currentIndex += direction;
            setTrackPosition(true);

            if (manual) {
                resetAutoSlide();
            }
        }

        function buildSlides(urls) {
            heroTrack.innerHTML = '';
            slideCount = urls.length;
            useClones = slideCount > 1;

            if (!slideCount) {
                const placeholder = document.createElement('div');
                placeholder.className = 'hero-slide hero-slide-placeholder';
                placeholder.textContent = 'Main banner images coming soon.';
                heroTrack.appendChild(placeholder);
                toggleHandles(false);
                slideshowInitialized = false;
                return;
            }

            const slidesToRender = [];
            if (useClones) {
                slidesToRender.push(urls[slideCount - 1], ...urls, urls[0]);
                currentIndex = 1;
            } else {
                slidesToRender.push(...urls);
                currentIndex = 0;
            }

            slidesToRender.forEach((url, index) => {
                const slide = document.createElement('div');
                slide.className = 'hero-slide';
                const img = document.createElement('img');
                img.src = url;
                img.alt = `Main banner image ${useClones ? ((index || slideCount) % slideCount) + 1 : index + 1}`;
                
                // Add error handling for images that fail to load
                img.onerror = function() {
                    console.error('Failed to load banner image:', url);
                };
                
                slide.appendChild(img);
                heroTrack.appendChild(slide);
            });

            toggleHandles(slideCount > 1);
            requestAnimationFrame(() => setTrackPosition(false));
            startAutoSlide();
            slideshowInitialized = true;
            
            // Start the safeguard timer if slideshow has multiple slides
            startSafeguardTimer();
        }

        heroTrack.addEventListener('transitionend', () => {
            if (!useClones) {
                return;
            }

            if (currentIndex === 0) {
                currentIndex = slideCount;
                setTrackPosition(false);
            }

            if (currentIndex === slideCount + 1) {
                currentIndex = 1;
                setTrackPosition(false);
            }
        });

        prevButton.addEventListener('click', () => moveSlide(-1, true));
        nextButton.addEventListener('click', () => moveSlide(1, true));
        window.addEventListener('resize', () => setTrackPosition(false));

        fetchBannerUrls().then(buildSlides);

        // ============ INDEX ADS DISPLAY ============
        const adsSection = document.getElementById('index-ads-section');
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Validate and sanitize URL for CSS background-image
        function sanitizeImageUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            // Only allow HTTPS URLs from Firebase Storage or relative paths
            if (trimmed.startsWith('https://firebasestorage.googleapis.com/') || 
                trimmed.startsWith('https://storage.googleapis.com/')) {
                // Additional validation: ensure no quotes or parentheses that could break CSS
                if (trimmed.includes("'") || trimmed.includes('"') || trimmed.includes('(') || trimmed.includes(')')) {
                    return '';
                }
                return trimmed;
            }
            return '';
        }

        // Validate URL to prevent javascript: and other malicious schemes
        function sanitizeUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            if (trimmed.startsWith('http://') || trimmed.startsWith('https://') || trimmed.startsWith('/')) {
                return trimmed;
            }
            return ''; // Block non-HTTP(S) URLs
        }

        // Helper to render ad button
        function renderAdButton(ad, lang) {
            const link = sanitizeUrl(ad.link);
            const buttonTitle = escapeHtml(ad[`buttonTitle_${lang}`] || 'Learn More');
            return link ? `<a href="${escapeHtml(link)}" class="index-ad-button">${buttonTitle}</a>` : '';
        }

        async function loadIndexAds() {
            try {
                const snapshot = await get(dbRef(database, 'indexAds'));
                
                if (!snapshot.exists()) {
                    return; // No ads to display
                }

                const adsData = snapshot.val();
                
                // Check if we have all three ads with required data
                const ad1 = adsData.ad1;
                const ad2 = adsData.ad2;
                const ad3 = adsData.ad3;
                
                if (!ad1 || !ad2 || !ad3) {
                    return; // Not all ads configured
                }

                // Render the ads with proper escaping
                adsSection.innerHTML = `
                    <div class="index-ads-container">
                        <div class="index-ads-left" style="background-image: url('${sanitizeImageUrl(ad1.imageUrl)}');">
                            <div class="index-ad-content">
                                <div class="index-ad-top-text">${escapeHtml(ad1[`topText_${currentLang}`])}</div>
                                <div class="index-ad-bottom-text">${escapeHtml(ad1[`bottomText_${currentLang}`])}</div>
                                ${renderAdButton(ad1, currentLang)}
                            </div>
                        </div>
                        <div class="index-ads-right">
                            <div class="index-ads-right-top" style="background-image: url('${sanitizeImageUrl(ad2.imageUrl)}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad2[`topText_${currentLang}`])}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad2[`bottomText_${currentLang}`])}</div>
                                    ${renderAdButton(ad2, currentLang)}
                                </div>
                            </div>
                            <div class="index-ads-right-bottom" style="background-image: url('${sanitizeImageUrl(ad3.imageUrl)}');">
                                <div class="index-ad-content">
                                    <div class="index-ad-top-text">${escapeHtml(ad3[`topText_${currentLang}`])}</div>
                                    <div class="index-ad-bottom-text">${escapeHtml(ad3[`bottomText_${currentLang}`])}</div>
                                    ${renderAdButton(ad3, currentLang)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading index ads:', error);
            }
        }

        // Load ads after banner loads
        loadIndexAds();

        // ============ ABOUT US CONTENT ============
        // Load About Us content
        async function loadAboutUsContent() {
            try {
                const snapshot = await get(dbRef(database, 'aboutUs'));
                
                if (!snapshot.exists()) {
                    return;
                }
                
                const data = snapshot.val();
                
                // Set title
                document.getElementById('about-us-title').textContent = data.title[currentLang] || '';
                
                // Set left content
                document.getElementById('about-us-left-subtitle1').textContent = data.left.subtitle1[currentLang] || '';
                document.getElementById('about-us-left-subtitle2').textContent = data.left.subtitle2[currentLang] || '';
                document.getElementById('about-us-left-body').textContent = data.left.textBody[currentLang] || '';
                
                // Set right content
                document.getElementById('about-us-right-subtitle1').textContent = data.right.subtitle1[currentLang] || '';
                document.getElementById('about-us-right-subtitle2').textContent = data.right.subtitle2[currentLang] || '';
                document.getElementById('about-us-right-body').textContent = data.right.textBody[currentLang] || '';
                
            } catch (error) {
                console.error('Error loading About Us content:', error);
            }
        }

        // Load About Us after page loads
        loadAboutUsContent();

        // ============ ADS BOTTOM SECTION ============
        async function loadAdsBottom() {
            try {
                const snapshot = await get(dbRef(database, 'adsBottom'));
                
                if (!snapshot.exists()) {
                    return;
                }
                
                const data = snapshot.val();
                const currentLang = detectLanguage();
                const adsBottomSection = document.getElementById('ads-bottom-section');
                
                if (!data.titles || !data.ad1 || !data.ad2 || !data.ad3) {
                    return;
                }
                
                // Render with fixed structure
                adsBottomSection.innerHTML = `
                    <div class="ads-bottom-container" style="background-image: url('${sanitizeImageUrl(data.backgroundImage || '')}');">
                        <div class="ads-bottom-overlay"></div>
                        <div class="ads-bottom-content">
                            <div class="ads-bottom-titles">
                                <p class="ads-bottom-title">${escapeHtml(data.titles[`title1_${currentLang}`] || '')}</p>
                                <h2 class="ads-bottom-subtitle">${escapeHtml(data.titles[`title2_${currentLang}`] || '')}</h2>
                                <h3 class="ads-bottom-subtitle">${escapeHtml(data.titles[`title3_${currentLang}`] || '')}</h3>
                            </div>
                            <div class="ads-bottom-cards">
                                <div class="ads-bottom-card">
                                    <div class="ads-bottom-card-content">
                                        <img src="${sanitizeImageUrl(data.ad1.imageUrl)}" alt="${escapeHtml(data.ad1[`title_${currentLang}`] || '')}">
                                        <h4>${escapeHtml(data.ad1[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad1[`body_${currentLang}`] || '')}</p>
                                    </div>
                                </div>
                                <div class="ads-bottom-card">
                                    <div class="ads-bottom-card-content">
                                        <img src="${sanitizeImageUrl(data.ad2.imageUrl)}" alt="${escapeHtml(data.ad2[`title_${currentLang}`] || '')}">
                                        <h4>${escapeHtml(data.ad2[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad2[`body_${currentLang}`] || '')}</p>
                                    </div>
                                </div>
                                <div class="ads-bottom-card">
                                    <div class="ads-bottom-card-content">
                                        <img src="${sanitizeImageUrl(data.ad3.imageUrl)}" alt="${escapeHtml(data.ad3[`title_${currentLang}`] || '')}">
                                        <h4>${escapeHtml(data.ad3[`title_${currentLang}`] || '')}</h4>
                                        <p>${escapeHtml(data.ad3[`body_${currentLang}`] || '')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                adsBottomSection.style.display = 'block';
            } catch (error) {
                console.error('Error loading Ads Bottom:', error);
            }
        }
        
        // Load Ads Bottom after page loads
        loadAdsBottom();

        // ============ OUR PICKS MANAGEMENT ============
        // Constants
        const DEFAULT_BOOKING_URL = 'https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e';
        const MAX_CARD_DESCRIPTION_LENGTH = 120;
        
        // Load and display packages marked for "Our Picks"
        async function loadOurPicks() {
            try {
                const snapshot = await get(dbRef(database, 'packages'));
                
                if (!snapshot.exists()) {
                    return;
                }
                
                const packagesObj = snapshot.val();
                const packagesArray = Object.keys(packagesObj).map(key => ({
                    id: key,
                    ...packagesObj[key]
                }));
                
                // Filter packages that are active and marked to show in Our Picks
                const ourPicksPackages = packagesArray.filter(pkg => 
                    pkg.status === 'active' && pkg.showInOurPicks === true
                );
                
                if (ourPicksPackages.length === 0) {
                    return;
                }
                
                const section = document.getElementById('our-picks-section');
                const listContainer = document.getElementById('our-picks-list');
                const currentLang = document.documentElement.lang || 'en';
                
                // Render package cards
                listContainer.innerHTML = ourPicksPackages.map(pkg => {
                    const title = pkg[`title_${currentLang}`] || pkg.title_en || 'Untitled Package';
                    const description = pkg[`description_${currentLang}`] || pkg.description_en || '';
                    const shortDescription = description.length > MAX_CARD_DESCRIPTION_LENGTH 
                        ? description.substring(0, MAX_CARD_DESCRIPTION_LENGTH) + '...' 
                        : description;
                    const bookingLink = pkg.bookingLink || DEFAULT_BOOKING_URL;
                    
                    return `
                        <div class="our-picks-card" data-package-id="${pkg.id}">
                            ${pkg.imageUrl ? `<div class="our-picks-card-image" style="background-image: url('${pkg.imageUrl}');"></div>` : ''}
                            <div class="our-picks-card-content">
                                <h3 class="our-picks-card-title">${title}</h3>
                                <p class="our-picks-card-description">${shortDescription}</p>
                                <div class="our-picks-card-actions">
                                    <button class="btn view-details-btn" data-package-id="${pkg.id}">View Details</button>
                                    <a href="${bookingLink}" class="btn btn-secondary" target="_blank" rel="noopener noreferrer">Book Now</a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Show the section
                section.style.display = 'block';
                
                // Add event listeners for "View Details" buttons
                document.querySelectorAll('.view-details-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const packageId = e.target.dataset.packageId;
                        const pkg = ourPicksPackages.find(p => p.id === packageId);
                        if (pkg) {
                            openPackageModal(pkg, currentLang);
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error loading Our Picks:', error);
            }
        }
        
        // Open package modal with full details
        function openPackageModal(pkg, lang) {
            const title = pkg[`title_${lang}`] || pkg.title_en || 'Untitled Package';
            const description = pkg[`description_${lang}`] || pkg.description_en || '';
            const inclusions = pkg[`inclusions_${lang}`] || pkg.inclusions_en || '';
            const goodToKnow = pkg[`goodToKnow_${lang}`] || pkg.goodToKnow_en || '';
            const bookingLink = pkg.bookingLink || DEFAULT_BOOKING_URL;
            
            const inclusionsList = inclusions.split('\n').filter(line => line.trim()).map(line => 
                `<li>${line.trim()}</li>`
            ).join('');
            
            const goodToKnowList = goodToKnow.split('\n').filter(line => line.trim()).map(line => 
                `<li>${line.trim()}</li>`
            ).join('');
            
            const modalHTML = `
                <div id="package-modal" class="package-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
                    <div class="package-modal-overlay"></div>
                    <div class="package-modal-content">
                        <button class="package-modal-close" aria-label="Close modal">&times;</button>
                        ${pkg.imageUrl ? `<img src="${pkg.imageUrl}" alt="${title}" class="package-modal-image">` : ''}
                        <div class="package-modal-body">
                            <h2 id="modal-title" class="package-modal-title">${title}</h2>
                            <div class="package-modal-description">${description.replace(/\n/g, '<br>')}</div>
                            ${inclusionsList ? `
                                <div class="package-modal-section">
                                    <h3>Inclusions</h3>
                                    <ul class="package-modal-list">${inclusionsList}</ul>
                                </div>
                            ` : ''}
                            ${goodToKnowList ? `
                                <div class="package-modal-section">
                                    <h3>Good to Know</h3>
                                    <ul class="package-modal-list">${goodToKnowList}</ul>
                                </div>
                            ` : ''}
                            <div class="package-modal-actions">
                                <a href="${bookingLink}" class="btn btn-secondary" target="_blank" rel="noopener noreferrer">Book Now</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            
            // Close modal handlers
            const modal = document.getElementById('package-modal');
            const closeBtn = modal.querySelector('.package-modal-close');
            const overlay = modal.querySelector('.package-modal-overlay');
            
            // Handle Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            };
            
            const closeModal = () => {
                document.removeEventListener('keydown', handleEscape);
                modal.remove();
                document.body.style.overflow = '';
            };
            
            closeBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);
            document.addEventListener('keydown', handleEscape);
        }
        
        // Load Our Picks after page loads
        loadOurPicks();

        // ============ PAGE BACKGROUND MANAGEMENT ============
        // Load and display background image
        async function loadPageBackground() {
            try {
                const snapshot = await get(dbRef(database, 'indexBackground'));
                
                if (snapshot.exists()) {
                    const bgData = snapshot.val();
                    const bgElement = document.getElementById('page-background');
                    if (bgElement && bgData.url) {
                        bgElement.style.backgroundImage = `url('${bgData.url}')`;
                    }
                }
            } catch (error) {
                console.error('Error loading page background:', error);
            }
        }

        // Load background on page load
        loadPageBackground();
    </script>
    <script>
        const defaultPlusCode = '2FJJ+J4 Mechelen, Belgium';
        const fallbackLocation = { lat: 51.0259, lng: 4.4774 };
        const mapStyles = [
            { elementType: 'geometry', stylers: [{ color: '#141414' }] },
            { elementType: 'labels.text.fill', stylers: [{ color: '#c7c1b2' }] },
            { elementType: 'labels.text.stroke', stylers: [{ color: '#0b0b0b' }] },
            { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#8a7753' }] },
            { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#3a2f1f' }] },
            { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#efe7d6' }] },
            { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#1f1f1f' }] },
            { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#202020' }] },
            { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0d0d0d' }] }
        ];

        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: fallbackLocation,
                styles: mapStyles,
                streetViewControl: false,
                mapTypeControl: false,
                fullscreenControl: true
            });

            const marker = new google.maps.Marker({
                map,
                position: fallbackLocation,
                title: defaultPlusCode
            });

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: defaultPlusCode }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    marker.setPosition(location);
                } else {
                    console.warn('Unable to geocode plus code:', status);
                }
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATJkyi-UfgeSQl9znvGtL4P4N7rC9HDWM&callback=initMap"></script>
    <script src="booking-bar.js"></script>
</body>
</html>
