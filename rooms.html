<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms - Hotel Elisabeth Mechelen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main Navigation Menu -->
    <header class="main-menu">
        <a href="index.html">
            <img src="logo/elitext.png" alt="Hotel Elisabeth Mechelen" class="main-menu-logo">
        </a>
        <div class="mobile-header-controls">
            <a href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" class="booking-button" target="_blank" rel="noopener noreferrer" data-translate="nav.bookNow">Book Now</a>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu">
                ☰
            </button>
        </div>
        <nav class="main-nav" id="main-nav">
            <ul>
                <li><a href="index.html" data-translate="nav.home">Home</a></li>
                <li><a href="rooms.html" data-translate="nav.rooms">Rooms</a></li>
                <li><a href="packages.html" data-translate="nav.packages">Packages</a></li>
                <li><a href="facilities.html" data-translate="nav.facilities">Facilities</a></li>
                <li><a href="meetings.html" data-translate="nav.meetings">Meetings</a></li>
                <li><a href="info.html" data-translate="nav.info">Info</a></li>
                <li class="dropdown">
                    <button id="more-btn" data-translate="nav.more">More</button>
                    <div class="dropdown-menu" id="more-dropdown">
                        <a href="attractions.html" data-translate="nav.attractions">Attractions</a>
                        <a href="grouprequest.html" data-translate="nav.groupRequest">Group Request</a>
                    </div>
                </li>
                <li><a href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" class="booking-button" target="_blank" rel="noopener noreferrer" data-translate="nav.bookNow">Book Now</a></li>
            </ul>
        </nav>
    </header>
    

    <main class="rooms-main">
        <!-- Enhanced Hero Section -->
        <section class="rooms-hero-modern">
            <div class="rooms-hero-overlay"></div>
            <div class="rooms-hero-content">
                <span class="rooms-hero-tagline" data-translate="rooms.tagline">Exclusive Accommodations</span>
                <h1 class="rooms-hero-title-modern" data-translate="rooms.mainTitle">Discover Your Perfect Stay</h1>
                <p class="rooms-hero-subtitle-modern" data-translate="rooms.subtitle">Experience comfort and elegance in every detail</p>
                <div class="rooms-hero-divider"></div>
            </div>
        </section>

        <!-- Intro Section -->
        <section class="rooms-intro">
            <div class="rooms-intro-content">
                <h2 class="rooms-section-title" data-translate="rooms.sectionTitle">Our Rooms & Suites</h2>
                <p class="rooms-intro-text" data-translate="rooms.introText">Each of our thoughtfully designed rooms offers a perfect blend of contemporary style and timeless comfort. From cozy retreats to spacious suites, find your ideal sanctuary in the heart of Mechelen.</p>
            </div>
        </section>

        <!-- Rooms Showcase Container -->
        <section class="rooms-showcase">
            <div id="rooms-list-container" class="rooms-showcase-grid" aria-live="polite" aria-atomic="false">
                <p class="rooms-loading" data-translate="rooms.loading">Loading rooms...</p>
            </div>
        </section>

        <!-- Call to Action Section -->
        <section class="rooms-cta">
            <div class="rooms-cta-content">
                <h2 class="rooms-cta-title" data-translate="rooms.ctaTitle">Ready to Book Your Stay?</h2>
                <p class="rooms-cta-text" data-translate="rooms.ctaText">Experience the perfect blend of comfort and refinement</p>
                <div class="booking-bar booking-bar-modal">
                    <div class="booking-field">
                        <label for="checkin-date" data-translate="rooms.checkinLabel">Check-in</label>
                        <input type="text" id="checkin-date" data-translate="rooms.selectDatePlaceholder" placeholder="Select date" readonly>
                    </div>
                    <div class="booking-field">
                        <label for="checkout-date" data-translate="rooms.checkoutLabel">Check-out</label>
                        <input type="text" id="checkout-date" data-translate="rooms.selectDatePlaceholder" placeholder="Select date" readonly>
                    </div>
                    <button id="search-btn" class="btn booking-search-btn" data-translate="rooms.searchButton">Search</button>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Room Details Modal -->
    <div id="room-modal" class="room-modal" role="dialog" aria-modal="true" aria-labelledby="room-modal-title">
        <div class="room-modal-overlay"></div>
        <div class="room-modal-content">
            <button class="room-modal-close" aria-label="Close">&times;</button>
            <div id="room-modal-body"></div>
        </div>
    </div>

    <!-- Fullscreen Gallery Modal -->
    <div id="fullscreen-gallery" class="fullscreen-gallery" role="dialog" aria-modal="true" aria-label="Photo Gallery">
        <button class="fullscreen-gallery-close" aria-label="Close">&times;</button>
        <button class="fullscreen-gallery-prev" aria-label="Previous image">‹</button>
        <button class="fullscreen-gallery-next" aria-label="Next image">›</button>
        <div class="fullscreen-gallery-image-content">
            <img id="fullscreen-gallery-image" src="" alt="Room photo">
        </div>
        <div class="fullscreen-gallery-thumbnails" id="fullscreen-gallery-thumbnails">
            <!-- Thumbnails will be dynamically inserted here -->
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <!-- Logo Section -->
            <div class="footer-section footer-logo-section">
                <img src="logo/logo.png" alt="Hotel Elisabeth Logo" class="footer-logo">
            </div>

            <!-- Contact Section -->
            <div class="footer-section">
                <h3 data-translate="footer.contactTitle">Contact</h3>
                <div class="footer-contact-info">
                    <div class="footer-contact-item">
                        <strong data-translate="footer.phoneLabel">PHONE:</strong>
                        <a href="tel:+3215288400">+32 15 28 84 00</a>
                    </div>
                    <div class="footer-contact-item">
                        <strong data-translate="footer.emailLabel">EMAIL:</strong>
                        <a href="mailto:info@elisabeth-hotel.be">info@elisabeth-hotel.be</a>
                    </div>
                    <div class="footer-contact-item">
                        <strong data-translate="footer.addressLabel">ADDRESS:</strong>
                        <div class="footer-address">
                            <span>GOSWIN DE STASSARTSTRAAT</span>
                            <span>NR 26 / 28</span>
                            <span>MECHELEN 2800</span>
                            <span>BELGIUM</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Social Media Section -->
            <div class="footer-section">
                <h3 data-translate="footer.socialTitle">Social</h3>
                <div class="footer-social">
                    <a href="https://www.instagram.com/hotel.elisabeth" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z"/>
                        </svg>
                        Instagram
                    </a>
                    <a href="https://www.facebook.com/hotelelisabeth/" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </a>
                    <a href="https://www.linkedin.com/company/hotel-elisabeth-mechelen/" target="_blank" rel="noopener noreferrer" class="footer-social-link">
                        <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        LinkedIn
                    </a>
                </div>
            </div>

            <!-- Information Links Section -->
            <div class="footer-section">
                <h3 data-translate="footer.informationTitle">Information</h3>
                <div class="footer-info-links">
                    <a href="privacypolicy.html" data-translate="footer.privacyPolicy">Privacy Policy</a>
                    <a href="termsandconditions.html" data-translate="footer.termsConditions">Terms & Conditions</a>
                    <a href="policies.html" data-translate="footer.hotelPolicies">Hotel Policies</a>
                    <a href="careers.html" data-translate="footer.careers">Careers</a>
                </div>
            </div>
        </div>

        <!-- Footer Copyright -->
        <div class="footer-copyright-wrapper">
            <p class="footer-copyright">&copy; 2026 Hotel Elisabeth Mechelen. All rights reserved.</p>
        </div>

    </footer>

    <!-- Include booking bar script for DatePicker -->
    <script src="booking-bar.js"></script>

    <!-- Firebase and Rooms Display Script -->
    <script type="module">
        import { database } from './firebase-config.js';
        import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let roomsData = [];
        let amenitiesData = {};

        // Labels
        const labels = {
            bedType: 'Bed Type',
            maxOccupancy: 'Max Occupancy',
            roomSize: 'Room Size',
            description: 'Description',
            amenities: 'Amenities',
            viewGallery: 'View Photo Gallery',
            watchVideo: 'Watch Video Tour'
        };

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // JavaScript string escape function
        function escapeJs(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        // Load amenities
        async function loadAmenities() {
            try {
                let amenitiesSnapshot = await get(dbRef(database, 'amenitiesMaster'));
                if (!amenitiesSnapshot.exists()) {
                    amenitiesSnapshot = await get(dbRef(database, 'amenities'));
                }
                if (amenitiesSnapshot.exists()) {
                    amenitiesData = amenitiesSnapshot.val();
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
            }
        }

        // Load rooms
        async function loadRooms() {
            try {
                const roomsSnapshot = await get(dbRef(database, 'rooms'));
                if (roomsSnapshot.exists()) {
                    const roomsObj = roomsSnapshot.val();
                    // Filter to only show rooms with status 'available' or no status field (default to available)
                    roomsData = Object.keys(roomsObj)
                        .map(id => ({
                            id,
                            ...roomsObj[id]
                        }))
                        .filter(room => {
                            const status = room.status || 'available';
                            return status === 'available';
                        });
                    renderRooms();
                } else {
                    document.getElementById('rooms-list-container').innerHTML = '<p class="rooms-loading">No rooms available at the moment.</p>';
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                // Use demo data if Firebase fails
                useDemoData();
            }
        }

        // Demo data for testing/preview
        function useDemoData() {
            roomsData = [
                {
                    id: 'demo-1',
                    name_en: 'Deluxe Double Room',
                    bedType_en: 'King Size Bed',
                    description_en: 'Spacious and elegantly appointed, our Deluxe Double Room offers a perfect blend of comfort and sophistication. Featuring premium bedding, modern amenities, and a refined aesthetic, this room provides an ideal retreat after a day of exploring Mechelen.',
                    maxOccupancy: 2,
                    roomSize: 28,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1611892440504-42a792e24d32?w=800&h=600&fit=crop' }
                    ]
                },
                {
                    id: 'demo-2',
                    name_en: 'Superior Suite',
                    bedType_en: 'Queen Size Bed',
                    description_en: 'Experience luxury in our Superior Suite, featuring a separate living area, marble bathroom, and stunning city views. Perfect for extended stays or those seeking extra space and comfort. Each suite is thoughtfully designed with contemporary furnishings and premium amenities.',
                    maxOccupancy: 3,
                    roomSize: 42,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=800&h=600&fit=crop' }
                    ]
                },
                {
                    id: 'demo-3',
                    name_en: 'Executive Twin Room',
                    bedType_en: 'Two Single Beds',
                    description_en: 'Ideal for business travelers or friends traveling together, our Executive Twin Room offers two comfortable single beds, a spacious work area, and all the modern conveniences you need. The room combines functionality with elegant design.',
                    maxOccupancy: 2,
                    roomSize: 25,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1631049307264-da0ec9d70304?w=800&h=600&fit=crop' }
                    ]
                }
            ];
            renderRooms();
        }

        // Track current image index for each room card
        const roomImageIndices = {};

        // Initialize image indices
        function initializeImageIndices() {
            roomsData.forEach(room => {
                roomImageIndices[room.id] = 0;
            });
        }

        // Navigate room card images
        window.navigateRoomImage = function(roomId, direction, event) {
            event.stopPropagation();
            const room = roomsData.find(r => r.id === roomId);
            if (!room || !room.photos || room.photos.length <= 1) return;
            
            const currentIndex = roomImageIndices[roomId] || 0;
            const newIndex = (currentIndex + direction + room.photos.length) % room.photos.length;
            roomImageIndices[roomId] = newIndex;
            
            const imgElement = document.querySelector(`#room-card-${roomId} .room-feature-image`);
            if (imgElement) {
                imgElement.src = escapeHtml(room.photos[newIndex].url);
            }
        };

        // Render rooms
        function renderRooms() {
            const container = document.getElementById('rooms-list-container');
            
            if (roomsData.length === 0) {
                container.innerHTML = '<p class="rooms-loading">No rooms available at the moment.</p>';
                return;
            }

            initializeImageIndices();

            const roomsHTML = roomsData.map((room, index) => {
                const name = escapeHtml(room.name_en || '');
                const bedType = escapeHtml(room.bedType_en || '');
                const description = escapeHtml(room.description_en || '');
                
                // Get first photo for card display
                const firstPhoto = room.photos && room.photos.length > 0 ? room.photos[0].url : '';
                const hasMultiplePhotos = room.photos && room.photos.length > 1;
                const escapedRoomId = escapeHtml(room.id);
                
                // Create short teaser (first 150 characters of description)
                const teaser = description.length > 150 ? description.substring(0, 150) + '...' : description;
                
                // Determine if image should be on left or right (odd index = left, even index = right)
                const imageOnLeft = index % 2 === 0;

                return `
                    <article class="room-feature ${imageOnLeft ? 'image-left' : 'image-right'}" id="room-card-${escapedRoomId}">
                        <div class="room-feature-image-wrapper">
                            ${firstPhoto ? `
                                <div class="room-feature-image-clickable" onclick="openFullscreenGallery('${escapeJs(escapedRoomId)}')" style="cursor: pointer;">
                                    <img src="${escapeHtml(firstPhoto)}" alt="${name}" class="room-feature-image">
                                    <div class="room-feature-magnify-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="M21 21l-4.35-4.35"></path>
                                        </svg>
                                    </div>
                                </div>
                                ${hasMultiplePhotos ? `
                                    <button class="room-image-nav room-image-nav-left" 
                                            onclick="navigateRoomImage('${escapeJs(escapedRoomId)}', -1, event)"
                                            aria-label="Previous image">‹</button>
                                    <button class="room-image-nav room-image-nav-right" 
                                            onclick="navigateRoomImage('${escapeJs(escapedRoomId)}', 1, event)"
                                            aria-label="Next image">›</button>
                                    <div class="room-feature-badge">${room.photos.length} Photos</div>
                                ` : ''}
                            ` : `
                                <div class="room-feature-no-image">
                                    <span>No Image</span>
                                </div>
                            `}
                        </div>
                        <div class="room-feature-content">
                            <div class="room-feature-header">
                                <span class="room-feature-label">Room Type</span>
                                <h3 class="room-feature-name">${name}</h3>
                            </div>
                            <div class="room-feature-amenities">
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <span>${room.maxOccupancy} Guests</span>
                                </div>
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg>
                                    <span>${bedType}</span>
                                </div>
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                        <rect x="1" y="3" width="22" height="5"></rect>
                                        <line x1="10" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                    <span>${room.roomSize} m²</span>
                                </div>
                            </div>
                            ${teaser ? `<p class="room-feature-description">${teaser}</p>` : ''}
                            <div class="room-feature-actions">
                                <button class="room-feature-btn primary" onclick="openRoomModal('${escapeJs(escapedRoomId)}')">
                                    <span>Discover More</span>
                                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                </button>
                                <a class="room-feature-btn secondary" href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" target="_blank" rel="noopener noreferrer">
                                    <span>Book</span>
                                </a>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            container.innerHTML = roomsHTML;
        }

        // Cover Flow for Room Modal
        const roomCoverflowStates = {};
        const COVERFLOW_ANIMATION_DURATION = 600; // milliseconds - must match CSS transition duration

        window.initRoomCoverflow = function(roomId) {
            const container = document.getElementById(`coverflow-${roomId}`);
            if (!container) return;

            const items = Array.from(container.querySelectorAll('.coverflow-item'));
            if (items.length === 0) return;

            roomCoverflowStates[roomId] = {
                currentIndex: 0,
                items: items,
                isAnimating: false
            };

            // Lazy load initial visible images
            updateRoomCoverflowPositions(roomId);
            lazyLoadRoomCoverflowImages(roomId);

            // Add wheel event listener
            let lastWheelTime = 0;
            const wheelThrottle = 300; // ms between wheel navigations
            
            container.addEventListener('wheel', (e) => {
                const now = Date.now();
                if (now - lastWheelTime < wheelThrottle) {
                    return;
                }
                
                // Only prevent default if we're actually navigating the carousel
                const direction = e.deltaY > 0 ? 1 : -1;
                const state = roomCoverflowStates[roomId];
                if (state && !state.isAnimating) {
                    e.preventDefault();
                    lastWheelTime = now;
                    navigateRoomCoverflow(roomId, direction, e);
                }
            }, { passive: false });

            // Add touch support
            let touchStartX = 0;
            let touchEndX = 0;

            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe(roomId);
            }, { passive: true });

            function handleSwipe(roomId) {
                const threshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > threshold) {
                    if (diff > 0) {
                        // Swipe left - next image
                        navigateRoomCoverflow(roomId, 1);
                    } else {
                        // Swipe right - previous image
                        navigateRoomCoverflow(roomId, -1);
                    }
                }
            }

            // Add keyboard support when container is focused
            container.setAttribute('tabindex', '0');
            container.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateRoomCoverflow(roomId, -1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateRoomCoverflow(roomId, 1);
                }
            });
        }

        function updateRoomCoverflowPositions(roomId) {
            const state = roomCoverflowStates[roomId];
            if (!state) return;

            const { currentIndex, items } = state;
            const total = items.length;

            items.forEach((item, index) => {
                // Remove all position classes
                item.classList.remove('active', 'left-1', 'left-2', 'left-3', 'right-1', 'right-2', 'right-3', 'hidden', 'hidden-left', 'hidden-right');

                const diff = index - currentIndex;

                if (diff === 0) {
                    item.classList.add('active');
                } else if (diff === -1 || (diff === total - 1 && currentIndex === 0)) {
                    item.classList.add('left-1');
                } else if (diff === -2 || (diff === total - 2 && currentIndex <= 1)) {
                    item.classList.add('left-2');
                } else if (diff === -3 || (diff === total - 3 && currentIndex <= 2)) {
                    item.classList.add('left-3');
                } else if (diff === 1 || (diff === -(total - 1) && currentIndex === total - 1)) {
                    item.classList.add('right-1');
                } else if (diff === 2 || (diff === -(total - 2) && currentIndex >= total - 2)) {
                    item.classList.add('right-2');
                } else if (diff === 3 || (diff === -(total - 3) && currentIndex >= total - 3)) {
                    item.classList.add('right-3');
                } else {
                    // Determine if item should be hidden on left or right based on circular distance
                    // Calculate normalized difference (0 to total-1) to determine shortest path
                    const normalizedDiff = ((index - currentIndex) + total) % total;
                    const midpoint = total / 2;
                    
                    // Items past the midpoint are closer via the left path, so hide them on the left
                    // Items before the midpoint are closer via the right path, so hide them on the right
                    if (normalizedDiff > midpoint) {
                        item.classList.add('hidden-left');
                    } else {
                        item.classList.add('hidden-right');
                    }
                }
            });
        }

        function lazyLoadRoomCoverflowImages(roomId) {
            const state = roomCoverflowStates[roomId];
            if (!state) return;

            const { currentIndex, items } = state;
            
            // Load current and nearby images
            const indicesToLoad = [
                currentIndex,
                (currentIndex - 1 + items.length) % items.length,
                (currentIndex + 1) % items.length,
                (currentIndex - 2 + items.length) % items.length,
                (currentIndex + 2) % items.length
            ];

            indicesToLoad.forEach(idx => {
                const img = items[idx]?.querySelector('img[data-src]');
                if (img && img.dataset.src && (!img.src || img.src === img.baseURI)) {
                    img.src = img.dataset.src;
                }
            });
        }

        window.navigateRoomCoverflow = function(roomId, direction, event) {
            if (event) {
                event.stopPropagation();
            }

            const state = roomCoverflowStates[roomId];
            if (!state || state.isAnimating) return;

            state.isAnimating = true;
            const total = state.items.length;
            state.currentIndex = (state.currentIndex + direction + total) % total;

            updateRoomCoverflowPositions(roomId);
            lazyLoadRoomCoverflowImages(roomId);

            setTimeout(() => {
                state.isAnimating = false;
            }, COVERFLOW_ANIMATION_DURATION);
        };

        // Room Modal functionality
        let keyboardHandlerInitialized = false;
        
        function initializeKeyboardHandler() {
            if (keyboardHandlerInitialized) return;
            
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('room-modal');
                
                if (modal && modal.classList.contains('active')) {
                    if (e.key === 'Escape') closeRoomModal();
                }
            });
            
            keyboardHandlerInitialized = true;
        }

        // Video player
        window.playVideo = function(videoUrl) {
            const videoModal = document.createElement('div');
            videoModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            videoModal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; font-size: 30px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
                    <video src="${videoUrl}" controls autoplay style="max-width: 100%; max-height: 80vh; border-radius: 8px;"></video>
                </div>
            `;
            document.body.appendChild(videoModal);
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) videoModal.remove();
            });
        };

        // Room Modal functionality
        let lastFocusedElement = null;

        window.openRoomModal = function(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room) return;

            // Store the element that triggered the modal
            lastFocusedElement = document.activeElement;

            const name = escapeHtml(room.name_en || '');
            const bedType = escapeHtml(room.bedType_en || '');
            const description = escapeHtml(room.description_en || '');
            
            // Get amenities list
            const amenitiesList = room.amenities ? Object.keys(room.amenities).map(amenityId => {
                const amenity = amenitiesData[amenityId];
                return amenity ? escapeHtml(amenity.name_en || '') : '';
            }).filter(a => a) : [];

            const firstPhoto = room.photos && room.photos.length > 0 ? room.photos[0].url : '';
            const escapedRoomId = escapeJs(room.id);

            const modalBody = document.getElementById('room-modal-body');
            const hasMultiplePhotos = room.photos && room.photos.length > 1;
            
            modalBody.innerHTML = `
                <div class="room-modal-header">
                    ${firstPhoto ? `
                        <div class="coverflow-container" id="coverflow-${escapedRoomId}" data-room-id="${escapedRoomId}">
                            <div class="coverflow-wrapper">
                                ${room.photos.map((photo, idx) => `
                                    <div class="coverflow-item ${idx === 0 ? 'active' : ''}" 
                                         data-index="${idx}">
                                        <div class="coverflow-item-inner">
                                            <img src="" data-src="${escapeHtml(photo.url)}" alt="${name} - Photo ${idx + 1}">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${hasMultiplePhotos ? `
                                <button class="coverflow-nav coverflow-nav-prev" onclick="navigateRoomCoverflow('${escapedRoomId}', -1, event)" aria-label="Previous image">‹</button>
                                <button class="coverflow-nav coverflow-nav-next" onclick="navigateRoomCoverflow('${escapedRoomId}', 1, event)" aria-label="Next image">›</button>
                                <div class="coverflow-badge">${room.photos.length} Photos</div>
                            ` : ''}
                        </div>
                    ` : ''}
                    <h2 class="room-modal-title" id="room-modal-title">${name}</h2>
                </div>
                
                <div class="room-modal-details">
                    <div class="room-modal-specs">
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.maxOccupancy}</span>
                                <span class="room-modal-spec-value">${room.maxOccupancy} guests</span>
                            </div>
                        </div>
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.bedType}</span>
                                <span class="room-modal-spec-value">${bedType}</span>
                            </div>
                        </div>
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                <rect x="1" y="3" width="22" height="5"></rect>
                                <line x1="10" y1="12" x2="14" y2="12"></line>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.roomSize}</span>
                                <span class="room-modal-spec-value">${room.roomSize} m²</span>
                            </div>
                        </div>
                    </div>
                    
                    ${description ? `
                        <div class="room-modal-description">
                            <h3>${labels.description}</h3>
                            <p>${description}</p>
                        </div>
                    ` : ''}
                    
                    ${amenitiesList.length > 0 ? `
                        <div class="room-modal-amenities">
                            <h3>${labels.amenities}</h3>
                            <ul class="room-modal-amenities-list">
                                ${amenitiesList.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${room.video ? `
                        <div class="room-modal-actions">
                            <button class="btn room-modal-btn" onclick="playVideo('${escapeJs(room.video.url)}')">${labels.watchVideo}</button>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Booking Bar in Modal - Moved to Bottom -->
                <div class="room-modal-booking">
                    <h3>Book This Room</h3>
                    <div class="booking-bar booking-bar-modal">
                        <div class="booking-field">
                            <label for="modal-checkin-date" data-translate="rooms.checkinLabel">Check-in</label>
                            <input type="text" id="modal-checkin-date" data-translate="rooms.selectDatePlaceholder" placeholder="Select date" readonly>
                        </div>
                        <div class="booking-field">
                            <label for="modal-checkout-date" data-translate="rooms.checkoutLabel">Check-out</label>
                            <input type="text" id="modal-checkout-date" data-translate="rooms.selectDatePlaceholder" placeholder="Select date" readonly>
                        </div>
                        <button id="modal-search-btn" class="btn booking-search-btn" data-translate="rooms.searchButton">Search</button>
                    </div>
                </div>
            `;

            document.getElementById('room-modal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialize Cover Flow for the room modal
            if (firstPhoto) {
                requestAnimationFrame(() => {
                    initRoomCoverflow(escapedRoomId);
                });
            }

            // Initialize booking bar for modal
            initializeModalBookingBar();

            // Focus on close button for keyboard accessibility
            setTimeout(() => {
                document.querySelector('.room-modal-close').focus();
            }, 100);
        };

        function closeRoomModal() {
            document.getElementById('room-modal').classList.remove('active');
            document.body.style.overflow = '';
            
            // Destroy modal date pickers if they exist
            if (window.modalCheckinPicker) {
                window.modalCheckinPicker.destroy();
                window.modalCheckinPicker = null;
            }
            if (window.modalCheckoutPicker) {
                window.modalCheckoutPicker.destroy();
                window.modalCheckoutPicker = null;
            }
            
            // Return focus to the element that opened the modal
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        // Fullscreen Gallery functionality
        let fullscreenGalleryPhotos = [];
        let fullscreenGalleryIndex = 0;
        
        window.openFullscreenGallery = function(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room || !room.photos || room.photos.length === 0) return;
            
            fullscreenGalleryPhotos = room.photos;
            fullscreenGalleryIndex = 0;
            
            const gallery = document.getElementById('fullscreen-gallery');
            const galleryImage = document.getElementById('fullscreen-gallery-image');
            const thumbnailsContainer = document.getElementById('fullscreen-gallery-thumbnails');
            
            // Show current photo
            const currentPhoto = fullscreenGalleryPhotos[fullscreenGalleryIndex];
            const altText = currentPhoto.alt || `${room.name_en || 'Room'} - Photo ${fullscreenGalleryIndex + 1}`;
            galleryImage.src = currentPhoto.url;
            galleryImage.alt = escapeHtml(altText);
            
            // Render thumbnails
            thumbnailsContainer.innerHTML = fullscreenGalleryPhotos.map((photo, index) => {
                const thumbAlt = photo.alt || `Thumbnail ${index + 1}`;
                return `
                    <img src="${photo.url}" 
                         class="fullscreen-gallery-thumbnail ${index === fullscreenGalleryIndex ? 'active' : ''}" 
                         onclick="changeFullscreenGalleryPhoto(${index})"
                         alt="${escapeHtml(thumbAlt)}">
                `;
            }).join('');
            
            // Show gallery
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Move focus to close button for accessibility
            setTimeout(() => {
                const closeBtn = gallery.querySelector('.fullscreen-gallery-close');
                if (closeBtn) closeBtn.focus();
            }, 100);
        };
        
        window.changeFullscreenGalleryPhoto = function(index) {
            if (fullscreenGalleryPhotos.length === 0) return;
            
            fullscreenGalleryIndex = index;
            const galleryImage = document.getElementById('fullscreen-gallery-image');
            const currentPhoto = fullscreenGalleryPhotos[index];
            galleryImage.src = currentPhoto.url;
            const altText = currentPhoto.alt || `Room photo ${index + 1}`;
            galleryImage.alt = escapeHtml(altText);
            
            // Update active thumbnail
            document.querySelectorAll('.fullscreen-gallery-thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        };
        
        function navigateFullscreenGallery(direction) {
            if (fullscreenGalleryPhotos.length === 0) return;
            
            fullscreenGalleryIndex = (fullscreenGalleryIndex + direction + fullscreenGalleryPhotos.length) % fullscreenGalleryPhotos.length;
            changeFullscreenGalleryPhoto(fullscreenGalleryIndex);
        }
        
        window.closeFullscreenGallery = function() {
            const gallery = document.getElementById('fullscreen-gallery');
            gallery.classList.remove('active');
            document.body.style.overflow = '';
        };
        
        // Keyboard handler for fullscreen gallery (defined once)
        function handleFullscreenGalleryKeydown(e) {
            const gallery = document.getElementById('fullscreen-gallery');
            if (!gallery.classList.contains('active')) return;
            
            if (e.key === 'Escape') {
                closeFullscreenGallery();
            } else if (e.key === 'ArrowLeft') {
                navigateFullscreenGallery(-1);
            } else if (e.key === 'ArrowRight') {
                navigateFullscreenGallery(1);
            }
        }
        
        // Setup fullscreen gallery controls
        function initializeFullscreenGallery() {
            const gallery = document.getElementById('fullscreen-gallery');
            
            // Close button
            gallery.querySelector('.fullscreen-gallery-close').addEventListener('click', closeFullscreenGallery);
            
            // Navigation buttons
            gallery.querySelector('.fullscreen-gallery-prev').addEventListener('click', () => navigateFullscreenGallery(-1));
            gallery.querySelector('.fullscreen-gallery-next').addEventListener('click', () => navigateFullscreenGallery(1));
            
            // Keyboard navigation (add only once)
            document.addEventListener('keydown', handleFullscreenGalleryKeydown);
            
            // Click outside to close
            gallery.addEventListener('click', (e) => {
                if (e.target === gallery) {
                    closeFullscreenGallery();
                }
            });
        }

        // Initialize modal booking bar
        function initializeModalBookingBar() {
            const checkinInput = document.getElementById('modal-checkin-date');
            const checkoutInput = document.getElementById('modal-checkout-date');
            const searchBtn = document.getElementById('modal-search-btn');

            if (!checkinInput || !checkoutInput || !searchBtn) return;

            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Destroy existing pickers if they exist
            if (window.modalCheckinPicker) {
                window.modalCheckinPicker.destroy();
            }
            if (window.modalCheckoutPicker) {
                window.modalCheckoutPicker.destroy();
            }

            // Initialize check-in picker
            window.modalCheckinPicker = new DatePicker(checkinInput, {
                defaultDate: today,
                minDate: today,
                onChange: (selectedDate) => {
                    const nextDay = new Date(selectedDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    window.modalCheckoutPicker.setMinDate(nextDay);
                    
                    if (window.modalCheckoutPicker.getDate() < nextDay) {
                        window.modalCheckoutPicker.setDate(nextDay);
                    }
                }
            });

            // Initialize check-out picker
            window.modalCheckoutPicker = new DatePicker(checkoutInput, {
                defaultDate: tomorrow,
                minDate: tomorrow
            });

            // Search button functionality
            searchBtn.addEventListener('click', function() {
                const checkinDate = checkinInput.value;
                const checkoutDate = checkoutInput.value;
                
                if (checkinDate && checkoutDate) {
                    const url = `https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e?mewsStart=${checkinDate}&mewsEnd=${checkoutDate}&mewsRoute=rooms`;
                    window.open(url, '_blank');
                }
            });
        }

        // Room modal controls - only set up once
        let modalControlsInitialized = false;
        
        function initializeModalControls() {
            if (modalControlsInitialized) return;
            
            document.querySelector('.room-modal-close').addEventListener('click', closeRoomModal);
            document.querySelector('.room-modal-overlay').addEventListener('click', closeRoomModal);
            
            modalControlsInitialized = true;
        }

        // Initialize
        (async () => {
            await loadAmenities();
            await loadRooms();
            initializeModalControls();
            initializeFullscreenGallery();
            initializeKeyboardHandler();
        })();
    </script>
    
    <!-- Main Menu Script -->
    <script src="main-menu.js"></script>
    <script src="language-switcher.js"></script>
    <script type="module" src="elisabeth-translations.js"></script>

</body>
</html>
