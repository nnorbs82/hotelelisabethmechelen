<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms - Hotel Elisabeth Mechelen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght=100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Fixed Background Layer (iOS Compatible) -->
    <div id="page-background" class="page-background"></div>
    
    <header>
        <nav>
            <a class="nav-logo" href="index.html">
                <img src="logo/elitext.png" alt="Hotel Elisabeth Mechelen logo">
            </a>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="rooms.html">Rooms</a></li>
                <li><a href="packages.html">Packages</a></li>
                <li><a href="facilities.html">Facilities</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="info.html">Info</a></li>
                <li><a href="attractions.html">Attractions</a></li>
                <li><a href="photos.html">Photos</a></li>
            </ul>
        </nav>
    </header>

    <main class="rooms-main">
        <!-- Enhanced Hero Section -->
        <section class="rooms-hero-modern">
            <div class="rooms-hero-overlay"></div>
            <div class="rooms-hero-content">
                <span class="rooms-hero-tagline">Luxury Accommodations</span>
                <h1 class="rooms-hero-title-modern">Discover Your Perfect Stay</h1>
                <p class="rooms-hero-subtitle-modern">Experience comfort and elegance in every detail</p>
                <div class="rooms-hero-divider"></div>
            </div>
        </section>

        <!-- Intro Section -->
        <section class="rooms-intro">
            <div class="rooms-intro-content">
                <h2 class="rooms-section-title">Our Rooms & Suites</h2>
                <p class="rooms-intro-text">Each of our thoughtfully designed rooms offers a perfect blend of contemporary style and timeless comfort. From cozy retreats to spacious suites, find your ideal sanctuary in the heart of Mechelen.</p>
            </div>
        </section>

        <!-- Rooms Showcase Container -->
        <section class="rooms-showcase">
            <div id="rooms-list-container" class="rooms-showcase-grid" aria-live="polite" aria-atomic="false">
                <p class="rooms-loading">Loading rooms...</p>
            </div>
        </section>

        <!-- Call to Action Section -->
        <section class="rooms-cta">
            <div class="rooms-cta-content">
                <h2 class="rooms-cta-title">Ready to Book Your Stay?</h2>
                <p class="rooms-cta-text">Experience the perfect blend of comfort and luxury</p>
                <a href="https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e" target="_blank" rel="noopener noreferrer" class="rooms-cta-button">Book Now</a>
            </div>
        </section>
    </main>
    
    <!-- Room Details Modal -->
    <div id="room-modal" class="room-modal" role="dialog" aria-modal="true" aria-labelledby="room-modal-title">
        <div class="room-modal-overlay"></div>
        <div class="room-modal-content">
            <button class="room-modal-close" aria-label="Close">&times;</button>
            <div id="room-modal-body"></div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox" style="display: none;">
        <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
        <button class="lightbox-prev" aria-label="Previous photo">‹</button>
        <button class="lightbox-next" aria-label="Next photo">›</button>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="Room photo">
        </div>
        <div class="lightbox-thumbnails" id="lightbox-thumbnails">
            <!-- Thumbnails will be dynamically inserted here -->
        </div>
    </div>

    <footer>
        <p>&copy; 2026 Hotel Elisabeth Mechelen. All rights reserved.</p>
        <p>
            <a href="privacypolicy.html" style="color: var(--color-beige); margin: 0 1rem;">Privacy Policy</a> | 
            <a href="termsandconditions.html" style="color: var(--color-beige); margin: 0 1rem;">Terms & Conditions</a> | 
            <a href="policies.html" style="color: var(--color-beige); margin: 0 1rem;">Hotel Policies</a> | 
            <a href="career.html" style="color: var(--color-beige); margin: 0 1rem;">Careers</a>
        </p>
    </footer>

    <!-- Include booking bar script for DatePicker -->
    <script src="booking-bar.js"></script>

    <!-- Firebase and Rooms Display Script -->
    <script type="module">
        import { database } from './firebase-config.js';
        import { ref as dbRef, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        let roomsData = [];
        let amenitiesData = {};
        let currentLightboxRoom = null;
        let currentLightboxIndex = 0;

        // Labels
        const labels = {
            bedType: 'Bed Type',
            maxOccupancy: 'Max Occupancy',
            roomSize: 'Room Size',
            description: 'Description',
            amenities: 'Amenities',
            viewGallery: 'View Photo Gallery',
            watchVideo: 'Watch Video Tour'
        };

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // JavaScript string escape function
        function escapeJs(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        // Load amenities
        async function loadAmenities() {
            try {
                const amenitiesSnapshot = await get(dbRef(database, 'amenities'));
                if (amenitiesSnapshot.exists()) {
                    amenitiesData = amenitiesSnapshot.val();
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
            }
        }

        // Load rooms
        async function loadRooms() {
            try {
                const roomsSnapshot = await get(dbRef(database, 'rooms'));
                if (roomsSnapshot.exists()) {
                    const roomsObj = roomsSnapshot.val();
                    roomsData = Object.keys(roomsObj).map(id => ({
                        id,
                        ...roomsObj[id]
                    }));
                    renderRooms();
                    setPageBackground(); // Set page background after rooms are loaded
                } else {
                    document.getElementById('rooms-list-container').innerHTML = '<p class="rooms-loading">No rooms available at the moment.</p>';
                    setPageBackground(); // Still attempt to set background even if no rooms
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                // Use demo data if Firebase fails
                useDemoData();
            }
        }

        // Set page background to City Suite's first image
        function setPageBackground() {
            const pageBackground = document.getElementById('page-background');
            if (!pageBackground) return;
            
            // Find the City Suite room (case-insensitive search)
            const citySuiteRoom = roomsData.find(room => 
                room.name_en && room.name_en.toLowerCase().includes('city suite')
            );
            
            let imageUrl = null;
            
            if (citySuiteRoom && citySuiteRoom.photos && citySuiteRoom.photos.length > 0) {
                imageUrl = citySuiteRoom.photos[0].url;
            } else {
                // Fallback: use the first room's first image if City Suite is not found
                const firstRoom = roomsData.find(room => room.photos && room.photos.length > 0);
                if (firstRoom) {
                    imageUrl = firstRoom.photos[0].url;
                }
            }
            
            // Set background image with proper URL validation
            if (imageUrl) {
                try {
                    // Validate URL format and protocol
                    const url = new URL(imageUrl, window.location.href);
                    // Only allow http and https protocols
                    if (url.protocol === 'http:' || url.protocol === 'https:') {
                        // Use the validated URL's href property
                        pageBackground.style.backgroundImage = `url("${url.href}")`;
                    }
                } catch (e) {
                    console.error('Invalid image URL:', imageUrl);
                }
            }
        }

        // Demo data for testing/preview
        function useDemoData() {
            roomsData = [
                {
                    id: 'demo-1',
                    name_en: 'Deluxe Double Room',
                    bedType_en: 'King Size Bed',
                    description_en: 'Spacious and elegantly appointed, our Deluxe Double Room offers a perfect blend of comfort and sophistication. Featuring premium bedding, modern amenities, and a refined aesthetic, this room provides an ideal retreat after a day of exploring Mechelen.',
                    maxOccupancy: 2,
                    roomSize: 28,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1611892440504-42a792e24d32?w=800&h=600&fit=crop' }
                    ]
                },
                {
                    id: 'demo-2',
                    name_en: 'Superior Suite',
                    bedType_en: 'Queen Size Bed',
                    description_en: 'Experience luxury in our Superior Suite, featuring a separate living area, marble bathroom, and stunning city views. Perfect for extended stays or those seeking extra space and comfort. Each suite is thoughtfully designed with contemporary furnishings and premium amenities.',
                    maxOccupancy: 3,
                    roomSize: 42,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=800&h=600&fit=crop' }
                    ]
                },
                {
                    id: 'demo-3',
                    name_en: 'Executive Twin Room',
                    bedType_en: 'Two Single Beds',
                    description_en: 'Ideal for business travelers or friends traveling together, our Executive Twin Room offers two comfortable single beds, a spacious work area, and all the modern conveniences you need. The room combines functionality with elegant design.',
                    maxOccupancy: 2,
                    roomSize: 25,
                    photos: [
                        { url: 'https://images.unsplash.com/photo-1631049307264-da0ec9d70304?w=800&h=600&fit=crop' }
                    ]
                }
            ];
            renderRooms();
            setPageBackground(); // Set page background after demo data is loaded
        }

        // Track current image index for each room card
        const roomImageIndices = {};

        // Initialize image indices
        function initializeImageIndices() {
            roomsData.forEach(room => {
                roomImageIndices[room.id] = 0;
            });
        }

        // Navigate room card images
        window.navigateRoomImage = function(roomId, direction, event) {
            event.stopPropagation();
            const room = roomsData.find(r => r.id === roomId);
            if (!room || !room.photos || room.photos.length <= 1) return;
            
            const currentIndex = roomImageIndices[roomId] || 0;
            const newIndex = (currentIndex + direction + room.photos.length) % room.photos.length;
            roomImageIndices[roomId] = newIndex;
            
            const imgElement = document.querySelector(`#room-card-${roomId} .room-feature-image`);
            if (imgElement) {
                imgElement.src = escapeHtml(room.photos[newIndex].url);
            }
        };

        // Render rooms
        function renderRooms() {
            const container = document.getElementById('rooms-list-container');
            
            if (roomsData.length === 0) {
                container.innerHTML = '<p class="rooms-loading">No rooms available at the moment.</p>';
                return;
            }

            initializeImageIndices();

            const roomsHTML = roomsData.map((room, index) => {
                const name = escapeHtml(room.name_en || '');
                const bedType = escapeHtml(room.bedType_en || '');
                const description = escapeHtml(room.description_en || '');
                
                // Get first photo for card display
                const firstPhoto = room.photos && room.photos.length > 0 ? room.photos[0].url : '';
                const hasMultiplePhotos = room.photos && room.photos.length > 1;
                const escapedRoomId = escapeHtml(room.id);
                
                // Create short teaser (first 150 characters of description)
                const teaser = description.length > 150 ? description.substring(0, 150) + '...' : description;
                
                // Determine if image should be on left or right (odd index = left, even index = right)
                const imageOnLeft = index % 2 === 0;

                return `
                    <article class="room-feature ${imageOnLeft ? 'image-left' : 'image-right'}" id="room-card-${escapedRoomId}">
                        <div class="room-feature-image-wrapper">
                            ${firstPhoto ? `
                                <div class="room-feature-image-clickable" onclick="openLightbox('${escapeJs(escapedRoomId)}', ${roomImageIndices[room.id] || 0})" style="cursor: pointer;">
                                    <img src="${escapeHtml(firstPhoto)}" alt="${name}" class="room-feature-image">
                                    <div class="room-feature-magnify-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="M21 21l-4.35-4.35"></path>
                                        </svg>
                                    </div>
                                </div>
                                ${hasMultiplePhotos ? `
                                    <button class="room-image-nav room-image-nav-left" 
                                            onclick="navigateRoomImage('${escapeJs(escapedRoomId)}', -1, event)"
                                            aria-label="Previous image">‹</button>
                                    <button class="room-image-nav room-image-nav-right" 
                                            onclick="navigateRoomImage('${escapeJs(escapedRoomId)}', 1, event)"
                                            aria-label="Next image">›</button>
                                    <div class="room-feature-badge">${room.photos.length} Photos</div>
                                ` : ''}
                            ` : `
                                <div class="room-feature-no-image">
                                    <span>No Image</span>
                                </div>
                            `}
                        </div>
                        <div class="room-feature-content">
                            <div class="room-feature-header">
                                <span class="room-feature-label">Room Type</span>
                                <h3 class="room-feature-name">${name}</h3>
                            </div>
                            <div class="room-feature-amenities">
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <span>${room.maxOccupancy} Guests</span>
                                </div>
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg>
                                    <span>${bedType}</span>
                                </div>
                                <div class="room-feature-amenity">
                                    <svg class="room-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                        <rect x="1" y="3" width="22" height="5"></rect>
                                        <line x1="10" y1="12" x2="14" y2="12"></line>
                                    </svg>
                                    <span>${room.roomSize} m²</span>
                                </div>
                            </div>
                            ${teaser ? `<p class="room-feature-description">${teaser}</p>` : ''}
                            <div class="room-feature-actions">
                                <button class="room-feature-btn primary" onclick="openRoomModal('${escapeJs(escapedRoomId)}')">
                                    <span>Discover More</span>
                                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');

            container.innerHTML = roomsHTML;
        }

        // Lightbox functionality
        window.openLightbox = function(roomId, photoIndex) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room || !room.photos || room.photos.length === 0) return;

            currentLightboxRoom = room;
            currentLightboxIndex = photoIndex;

            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const thumbnailsContainer = document.getElementById('lightbox-thumbnails');

            // Show current photo
            lightboxImage.src = escapeHtml(room.photos[photoIndex].url);

            // Render thumbnails
            thumbnailsContainer.innerHTML = room.photos.map((photo, index) => `
                <img src="${escapeHtml(photo.url)}" 
                     class="lightbox-thumbnail ${index === photoIndex ? 'active' : ''}" 
                     onclick="changeLightboxPhoto(${index})"
                     alt="Thumbnail ${index + 1}">
            `).join('');

            lightbox.style.display = 'flex';
        };

        window.changeLightboxPhoto = function(index) {
            if (!currentLightboxRoom || !currentLightboxRoom.photos) return;

            currentLightboxIndex = index;
            const lightboxImage = document.getElementById('lightbox-image');
            lightboxImage.src = escapeHtml(currentLightboxRoom.photos[index].url);

            // Update active thumbnail
            document.querySelectorAll('.lightbox-thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        };

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            currentLightboxRoom = null;
            currentLightboxIndex = 0;
        }

        function nextPhoto() {
            if (!currentLightboxRoom || !currentLightboxRoom.photos) return;
            const nextIndex = (currentLightboxIndex + 1) % currentLightboxRoom.photos.length;
            changeLightboxPhoto(nextIndex);
        }

        function prevPhoto() {
            if (!currentLightboxRoom || !currentLightboxRoom.photos) return;
            const prevIndex = (currentLightboxIndex - 1 + currentLightboxRoom.photos.length) % currentLightboxRoom.photos.length;
            changeLightboxPhoto(prevIndex);
        }

        // Lightbox controls
        document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
        document.querySelector('.lightbox-next').addEventListener('click', nextPhoto);
        document.querySelector('.lightbox-prev').addEventListener('click', prevPhoto);

        // Close on background click
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target.id === 'lightbox') {
                closeLightbox();
            }
        });

        // Keyboard navigation - consolidated handler
        let keyboardHandlerInitialized = false;
        
        function initializeKeyboardHandler() {
            if (keyboardHandlerInitialized) return;
            
            document.addEventListener('keydown', (e) => {
                const lightbox = document.getElementById('lightbox');
                const modal = document.getElementById('room-modal');
                
                if (lightbox.style.display === 'flex') {
                    if (e.key === 'Escape') closeLightbox();
                    if (e.key === 'ArrowRight') nextPhoto();
                    if (e.key === 'ArrowLeft') prevPhoto();
                } else if (modal && modal.classList.contains('active')) {
                    if (e.key === 'Escape') closeRoomModal();
                }
            });
            
            keyboardHandlerInitialized = true;
        }

        // Video player
        window.playVideo = function(videoUrl) {
            const videoModal = document.createElement('div');
            videoModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            videoModal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; font-size: 30px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
                    <video src="${videoUrl}" controls autoplay style="max-width: 100%; max-height: 80vh; border-radius: 8px;"></video>
                </div>
            `;
            document.body.appendChild(videoModal);
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) videoModal.remove();
            });
        };

        // Room Modal functionality
        let lastFocusedElement = null;

        window.openRoomModal = function(roomId) {
            const room = roomsData.find(r => r.id === roomId);
            if (!room) return;

            // Store the element that triggered the modal
            lastFocusedElement = document.activeElement;

            const name = escapeHtml(room.name_en || '');
            const bedType = escapeHtml(room.bedType_en || '');
            const description = escapeHtml(room.description_en || '');
            
            // Get amenities list
            const amenitiesList = room.amenities ? Object.keys(room.amenities).map(amenityId => {
                const amenity = amenitiesData[amenityId];
                return amenity ? escapeHtml(amenity.name_en || '') : '';
            }).filter(a => a) : [];

            const firstPhoto = room.photos && room.photos.length > 0 ? room.photos[0].url : '';
            const escapedRoomId = escapeJs(room.id);

            const modalBody = document.getElementById('room-modal-body');
            modalBody.innerHTML = `
                <div class="room-modal-header">
                    ${firstPhoto ? `
                        <div class="room-modal-hero" style="cursor: pointer;" onclick="openLightbox('${escapedRoomId}', 0)">
                            <img src="${escapeHtml(firstPhoto)}" alt="${name}">
                            ${room.photos && room.photos.length > 1 ? `
                                <div class="room-modal-photo-badge">${room.photos.length} photos - Click to view gallery</div>
                            ` : ''}
                        </div>
                    ` : ''}
                    <h2 class="room-modal-title" id="room-modal-title">${name}</h2>
                </div>
                
                <div class="room-modal-details">
                    <div class="room-modal-specs">
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.maxOccupancy}</span>
                                <span class="room-modal-spec-value">${room.maxOccupancy} guests</span>
                            </div>
                        </div>
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.bedType}</span>
                                <span class="room-modal-spec-value">${bedType}</span>
                            </div>
                        </div>
                        <div class="room-modal-spec">
                            <svg class="room-modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="21 8 21 21 3 21 3 8"></polyline>
                                <rect x="1" y="3" width="22" height="5"></rect>
                                <line x1="10" y1="12" x2="14" y2="12"></line>
                            </svg>
                            <div class="room-modal-spec-content">
                                <span class="room-modal-spec-label">${labels.roomSize}</span>
                                <span class="room-modal-spec-value">${room.roomSize} m²</span>
                            </div>
                        </div>
                    </div>
                    
                    ${description ? `
                        <div class="room-modal-description">
                            <h3>${labels.description}</h3>
                            <p>${description}</p>
                        </div>
                    ` : ''}
                    
                    ${amenitiesList.length > 0 ? `
                        <div class="room-modal-amenities">
                            <h3>${labels.amenities}</h3>
                            <ul class="room-modal-amenities-list">
                                ${amenitiesList.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${room.video ? `
                        <div class="room-modal-actions">
                            <button class="btn room-modal-btn" onclick="playVideo('${escapeJs(room.video.url)}')">${labels.watchVideo}</button>
                        </div>
                    ` : ''}
                    
                    <!-- Booking Bar in Modal -->
                    <div class="room-modal-booking">
                        <h3>Book This Room</h3>
                        <div class="booking-bar booking-bar-modal">
                            <div class="booking-field">
                                <label for="modal-checkin-date">Check-in</label>
                                <input type="text" id="modal-checkin-date" placeholder="Select date" readonly>
                            </div>
                            <div class="booking-field">
                                <label for="modal-checkout-date">Check-out</label>
                                <input type="text" id="modal-checkout-date" placeholder="Select date" readonly>
                            </div>
                            <button id="modal-search-btn" class="btn booking-search-btn">Search</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('room-modal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Initialize booking bar for modal
            initializeModalBookingBar();

            // Focus on close button for keyboard accessibility
            setTimeout(() => {
                document.querySelector('.room-modal-close').focus();
            }, 100);
        };

        function closeRoomModal() {
            document.getElementById('room-modal').classList.remove('active');
            document.body.style.overflow = '';
            
            // Destroy modal date pickers if they exist
            if (window.modalCheckinPicker) {
                window.modalCheckinPicker.destroy();
                window.modalCheckinPicker = null;
            }
            if (window.modalCheckoutPicker) {
                window.modalCheckoutPicker.destroy();
                window.modalCheckoutPicker = null;
            }
            
            // Return focus to the element that opened the modal
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        // Initialize modal booking bar
        function initializeModalBookingBar() {
            const checkinInput = document.getElementById('modal-checkin-date');
            const checkoutInput = document.getElementById('modal-checkout-date');
            const searchBtn = document.getElementById('modal-search-btn');

            if (!checkinInput || !checkoutInput || !searchBtn) return;

            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Destroy existing pickers if they exist
            if (window.modalCheckinPicker) {
                window.modalCheckinPicker.destroy();
            }
            if (window.modalCheckoutPicker) {
                window.modalCheckoutPicker.destroy();
            }

            // Initialize check-in picker
            window.modalCheckinPicker = new DatePicker(checkinInput, {
                defaultDate: today,
                minDate: today,
                onChange: (selectedDate) => {
                    const nextDay = new Date(selectedDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    window.modalCheckoutPicker.setMinDate(nextDay);
                    
                    if (window.modalCheckoutPicker.getDate() < nextDay) {
                        window.modalCheckoutPicker.setDate(nextDay);
                    }
                }
            });

            // Initialize check-out picker
            window.modalCheckoutPicker = new DatePicker(checkoutInput, {
                defaultDate: tomorrow,
                minDate: tomorrow
            });

            // Search button functionality
            searchBtn.addEventListener('click', function() {
                const checkinDate = checkinInput.value;
                const checkoutDate = checkoutInput.value;
                
                if (checkinDate && checkoutDate) {
                    const url = `https://app.mews.com/distributor/6e37d724-4c4d-4df9-9247-49442b7dd19e?mewsStart=${checkinDate}&mewsEnd=${checkoutDate}&mewsRoute=rooms`;
                    window.open(url, '_blank');
                }
            });
        }

        // Room modal controls - only set up once
        let modalControlsInitialized = false;
        
        function initializeModalControls() {
            if (modalControlsInitialized) return;
            
            document.querySelector('.room-modal-close').addEventListener('click', closeRoomModal);
            document.querySelector('.room-modal-overlay').addEventListener('click', closeRoomModal);
            
            modalControlsInitialized = true;
        }

        // Initialize
        (async () => {
            await loadAmenities();
            await loadRooms();
            initializeModalControls();
            initializeKeyboardHandler();
        })();
    </script>
</body>
</html>
